<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>WebCurl</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            min-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .request-section {
            margin-bottom: 20px;
        }

        .url-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        select,
        input,
        textarea,
        button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        select {
            width: 100px;
        }

        input[type="url"] {
            flex: 1;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .tab.active {
            border: 1px solid #ddd;
            border-bottom: none;
            background-color: white;
            margin-bottom: -1px;
        }

        .tab-content {
            display: none;
            min-height: 300px;
        }

        .tab-content.active {
            display: block;
        }

        .header-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .header-row input[type="text"] {
            flex: 1;
        }

        .remove-btn {
            background-color: #f44336;
        }

        .response-section {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .response-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f8f8;
        }

        .response-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .response-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-right: 5px;
        }

        .response-tab.active {
            border: 1px solid #ddd;
            border-bottom: none;
            background-color: white;
            margin-bottom: -1px;
        }

        .response-tab-content {
            display: none;
            padding: 15px 0;
        }

        .response-tab-content.active {
            display: block;
        }

        #responseBody {
            width: 100%;
            min-height: 200px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .file-input-container {
            margin-top: 10px;
        }

        .file-list {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #f5f5f5;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .headers-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .headers-table th,
        .headers-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .headers-table th {
            background-color: #f5f5f5;
        }

        .formdata-type-select {
            width: 100px;
            margin-right: 10px;
        }

        .formdata-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .formdata-list {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .formdata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f5f5f5;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .formdata-item span {
            flex: 1;
        }

        .type-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 8px;
        }

        .type-file {
            background-color: #e1f5fe;
            color: #0277bd;
        }

        .type-text {
            background-color: #f1f8e9;
            color: #558b2f;
        }

        .formdata-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: start;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            width: 100%;
        }

        .formdata-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            margin-top: 10px;
        }

        .formdata-key {
            width: 30%;
            min-width: 200px;
        }

        .formdata-type {
            width: 15%;
            min-width: 120px;
        }

        .formdata-value {
            flex: 1;
            min-width: 200px;
        }

        .formdata-value .text-input {
            width: 100%;
            height: 36px;
        }

        .formdata-value .file-input {
            width: 100%;
            height: 36px;
            padding: 6px;
            box-sizing: border-box;
        }

        .formdata-value .file-input::-webkit-file-upload-button {
            height: 22px;
            padding: 0 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 3px;
        }

        .file-preview {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .file-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 5px;
            background: #e3f2fd;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        .add-row-btn {
            margin-top: 10px;
            background-color: #2196F3;
            padding: 8px 16px;
            font-size: 14px;
            min-width: 100px;
            height: 36px;
        }

        /* 按鈕樣式優化 */
        .btn-primary {
            background-color: #4CAF50;
        }

        .btn-secondary {
            background-color: #2196F3;
        }

        .btn-danger {
            background-color: #f44336;
        }

        /* 容器樣式 */
        .container-hidden {
            display: none;
        }

        .container-margin-top {
            margin-top: 10px;
        }

        /* 輸入框樣式 */
        .input-full-width {
            width: 100%;
        }

        .input-remark {
            width: 80px;
        }

        .input-number {
            width: 100%;
        }

        .input-ws-send {
            width: 60%;
        }

        /* 表格樣式 */
        .table-col-enable {
            width: 50px;
        }

        .table-col-action {
            width: 80px;
        }

        /* 文本域樣式 */
        .textarea-body {
            width: 100%;
            height: 150px;
            font-family: monospace;
            resize: vertical;
        }

        /* 文件輸入框樣式 */
        .file-input-binary {
            width: 100%;
            height: 36px;
            padding: 6px;
            box-sizing: border-box;
        }

        .file-input-ws {
            display: none;
            width: 180px;
        }

        /* 選擇框樣式 */
        .select-formdata-type {
            width: 30px;
        }

        /* 分隔線樣式 */
        .divider {
            margin: 15px 0;
        }

        /* 設置輸入框樣式 */
        .setting-input {
            width: 100%;
        }

        .setting-input-integrity {
            display: none;
            width: 100%;
            margin-top: 5px;
        }

        /* 集合選擇器樣式 */
        .collection-selector {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 文件輸入框默認隱藏 */
        .file-input {
            display: none;
        }

        /* 表單備注樣式 */
        .form-remark {
            width: 80px;
        }

        .body-type-radio {
            display: inline-flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .body-type-radio label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .body-type-radio input[type="radio"] {
            cursor: pointer;
        }

        #bodyTab {
            position: relative;
            width: 100%;
        }

        #formContainer,
        #formDataContainer {
            width: 100%;
        }

        .content-wrapper {
            display: flex;
            gap: 10px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .aside {
            width: 30%;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 40px);
            overflow-y: scroll;
        }

        .global-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .global-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 13px;
        }

        .global-export-btn {
            background-color: #4CAF50;
        }

        .global-import-btn {
            background-color: #2196F3;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .panel-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            flex: 1;
            text-align: center;
        }

        .panel-tab.active {
            border: 1px solid #ddd;
            border-bottom: none;
            background-color: white;
            margin-bottom: -1px;
        }

        .panel-content {
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-header .btn-group {
            display: flex;
            gap: 5px;
        }

        .export-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .import-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-history-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-history-btn:hover {
            background-color: #d32f2f;
        }

        .history-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
            position: relative;
        }

        .history-item:hover {
            background-color: #f5f5f5;
        }

        .history-method {
            font-weight: bold;
            color: #2196F3;
            margin-right: 8px;
        }

        .history-url {
            color: #666;
            word-break: break-all;
            margin-bottom: 5px;
        }

        .history-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .history-load-btn {
            background-color: #4CAF50;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            height: 24px;
            color: white;
            margin: 2px;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        .settings-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .settings-dialog h3 {
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .settings-group select {
            width: 100%;
            margin-bottom: 10px;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-btn {
            background-color: #2196F3;
            margin-right: 10px;
        }

        .save-api-btn {
            background-color: #FFA000;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .save-api-btn:hover {
            background-color: #F57C00;
        }

        .api-name {
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 5px;
        }

        .history-item button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            height: 24px;
            color: white;
            margin: 2px;
        }

        .history-item .history-load-btn {
            background-color: #4CAF50;
        }

        .history-item .remove-btn {
            background-color: #f44336;
        }

        .variables-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .variables-table th,
        .variables-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .variables-table th {
            background-color: #f5f5f5;
        }

        .variables-table input[type="text"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .variables-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .variables-table .remove-btn {
            padding: 4px 8px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .variables-table .remove-btn:hover {
            background-color: #d32f2f;
        }

        /* 多行請求體樣式 */
        .body-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: start;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            width: 100%;
        }

        .body-row input[type="radio"] {
            width: 16px;
            height: 16px;
            margin: 0;
            margin-top: 10px;
        }

        .body-content {
            flex: 1;
            min-width: 200px;
        }

        .body-content textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            resize: vertical;
        }

        .body-content input[type="file"] {
            width: 100%;
            height: 36px;
            padding: 6px;
            box-sizing: border-box;
        }

        .body-remark {
            width: 120px;
            min-width: 120px;
            height: 150px;
            resize: vertical;
            font-family: monospace;
        }

        .body-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .body-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }

        .body-actions .remove-btn {
            background-color: #f44336;
        }

        /* JSON格式化高亮樣式 */
        .json-formatted {
            background: #f5f5f5;
            color: #222;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }

        .json-formatted .json-key {
            color: #1a7ab6;
        }

        .json-formatted .json-string {
            color: #c41a16;
        }

        .json-formatted .json-number {
            color: #1c00cf;
        }

        .json-formatted .json-boolean,
        .json-formatted .json-null {
            color: #aa0d91;
        }

        .json-formatted .json-bracket {
            color: #888;
        }

        .json-formatted .json-arrow {
            cursor: pointer;
            user-select: none;
            color: #888;
            margin-right: 4px;
        }

        .json-formatted .json-container {
            margin-left: 20px;
        }

        .json-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .json-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            background-color: #4CAF50;
        }

        .json-actions button:hover {
            background-color: #45a049;
        }

        #wsBodyContainer {
            width: 100%;
        }

        #wsBodyRows .body-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            width: 100%;
        }

        #wsBodyRows .body-row input[type="radio"] {
            width: 18px;
        }

        #wsBodyRows .ws-body-type {
            min-width: 180px;
            max-width: 200px;
        }

        #wsBodyRows .ws-body-content {
            flex: 1;
            width: 100%;
        }

        #wsBodyRows .ws-body-text {
            width: 100%;
            min-height: 36px;
            resize: vertical;
        }

        #wsBodyRows .ws-body-file {
            width: 100%;
        }

        #wsBodyRows .body-remark {
            min-width: 120px;
            max-width: 200px;
            flex: 0 0 160px;
            height: 36px;
            resize: vertical;
        }

        #wsBodyRows .remove-btn {
            min-width: 60px;
        }

        #wsBodyContainer .ws-body-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        select option {
            min-height: 32px;
            padding: 8px 10px;
            font-size: 15px;
        }
    </style>
</head>

<body>
    <div class="content-wrapper">
        <div class="aside">
            <div class="global-actions">
                <button class="global-export-btn" onclick="exportAllConfig()">導出全部配置</button>
                <button class="global-import-btn" onclick="importAllConfig()">導入全部配置</button>
                <button class="settings-btn" onclick="openSettings()">請求配置</button>
                <button class="settings-btn" onclick="window.open('/tool.html')">常用工具</button>
            </div>
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchPanelTab('history')">歷史</div>
                <div class="panel-tab" onclick="switchPanelTab('apis')">接口</div>
                <div class="panel-tab" onclick="switchPanelTab('variables')">變量</div>
                <div class="panel-tab" onclick="switchPanelTab('globalHeaders')">全局頭</div>
            </div>
            <div id="historyPanel" class="panel-content active">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="clear-history-btn" onclick="clearHistory()">清空歷史</button>
                        <button class="import-btn" onclick="importHistory()">導入歷史</button>
                        <button class="export-btn" onclick="exportHistory()">導出歷史</button>
                    </div>
                </div>
                <div id="historyList"></div>
            </div>
            <div id="apisPanel" class="panel-content">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="clear-history-btn" onclick="clearApis()">清空列表</button>
                        <button class="import-btn" onclick="importApis()">導入接口</button>
                        <button class="export-btn" onclick="exportApis()">導出接口</button>
                    </div>
                </div>
                <!-- 集合管理UI -->
                <div class="collection-selector">
                    <label>集合：</label>
                    <select id="apiCollectionSelect" onchange="switchApiCollection()"></select>
                    <button onclick="addApiCollection()">新增集合</button>
                    <button onclick="removeApiCollection()">刪除集合</button>
                </div>
                <div id="apisList"></div>
            </div>
            <div id="variablesPanel" class="panel-content">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="clear-history-btn" onclick="clearVariables()">清空變量</button>
                        <button class="import-btn" onclick="importVariables()">導入變量</button>
                        <button class="export-btn" onclick="exportVariables()">導出變量</button>
                    </div>
                </div>
                <div class="variables-table-container">
                    <table class="variables-table">
                        <thead>
                            <tr>
                                <th class="table-col-enable">啟用</th>
                                <th>變量名</th>
                                <th>變量值</th>
                                <th class="table-col-action">操作</th>
                            </tr>
                        </thead>
                        <tbody id="variablesTableBody"></tbody>
                    </table>
                    <button class="add-row-btn" onclick="addVariableRow()">添加變量</button>
                    <button class="save-btn btn-primary" onclick="saveVariables()">保存變量</button>
                </div>
            </div>
            <div id="globalHeadersPanel" class="panel-content">
                <div class="history-header">
                    <div class="btn-group">
                        <button class="clear-history-btn" onclick="clearGlobalHeaders()">清空全局頭</button>
                        <button class="import-btn" onclick="importGlobalHeaders()">導入全局頭</button>
                        <button class="export-btn" onclick="exportGlobalHeaders()">導出全局頭</button>
                    </div>
                </div>
                <div class="variables-table-container">
                    <table class="variables-table">
                        <thead>
                            <tr>
                                <th class="table-col-enable">啟用</th>
                                <th>請求頭</th>
                                <th>請求值</th>
                                <th class="table-col-action">操作</th>
                            </tr>
                        </thead>
                        <tbody id="globalHeadersTableBody"></tbody>
                    </table>
                    <button class="add-row-btn" onclick="addGlobalHeaderRow()">添加全局頭</button>
                    <button class="save-btn btn-primary" onclick="saveGlobalHeaders()">保存全局頭</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="container">
                <div class="request-section">
                    <div class="url-section">
                        <button class="new-request-btn" onclick="newRequest()">新建</button>
                        <select id="httpMethod">
                            <option>GET</option>
                            <option>POST</option>
                            <option>PUT</option>
                            <option>DELETE</option>
                            <option>PATCH</option>
                            <option>HEAD</option>
                            <option>OPTIONS</option>
                            <option>CONNECT</option>
                            <option>TRACE</option>
                            <option>WS</option>
                            <option>SSE</option>
                        </select>
                        <input type="url" id="url" placeholder="輸入請求URL" value="" />
                        <button onclick="saveToApis()" class="btn-secondary">保存</button>
                        <button id="downloadBtn" onclick="sendRequestAndDownload()" class="btn-secondary">下載</button>
                        <button id="sendBtn" onclick="sendRequest()">發送請求</button>
                    </div>

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('headers')">請求頭</div>
                        <div class="tab" onclick="switchTab('body')">請求體</div>
                    </div>

                    <div id="headersTab" class="tab-content active">
                        <div id="headersList">
                            <div class="header-row">
                                <input type="checkbox" checked>
                                <input type="text" placeholder="Header名稱" />
                                <input type="text" placeholder="Header值" />
                                <input type="text" placeholder="備注" class="header-remark input-remark" />
                                <button class="remove-btn" onclick="removeHeader(this)">刪除</button>
                            </div>
                        </div>
                        <button onclick="addHeader()">添加請求頭</button>
                    </div>

                    <div id="bodyTab" class="tab-content">
                        <div class="body-type-radio">
                            <label>
                                <input type="radio" name="bodyType" value="none" checked
                                    onchange="updateBodyType(this.value)">
                                <span>無請求體</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="json" onchange="updateBodyType(this.value)">
                                <span>JSON</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="text" onchange="updateBodyType(this.value)">
                                <span>Text</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="binary"
                                    onchange="updateBodyType(this.value)">
                                <span>Binary</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="form" onchange="updateBodyType(this.value)">
                                <span>application/x-www-form-urlencoded</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="formdata"
                                    onchange="updateBodyType(this.value)">
                                <span>form-data</span>
                            </label>
                            <label>
                                <input type="radio" name="bodyType" value="websocket"
                                    onchange="updateBodyType(this.value)">
                                <span>WebSocket</span>
                            </label>
                        </div>
                        <div id="jsonBodyContainer" class="container-hidden">
                            <div id="jsonBodyRows"></div>
                            <div class="body-actions">
                                <button class="add-row-btn" onclick="addJsonBodyRow()">添加JSON行</button>
                            </div>
                        </div>
                        <div id="textBodyContainer" class="container-hidden">
                            <div id="textBodyRows"></div>
                            <div class="body-actions">
                                <button class="add-row-btn" onclick="addTextBodyRow()">添加Text行</button>
                            </div>
                        </div>
                        <div id="binaryBodyContainer" class="container-hidden">
                            <div id="binaryBodyRows"></div>
                            <div class="body-actions">
                                <button class="add-row-btn" onclick="addBinaryBodyRow()">添加Binary行</button>
                            </div>
                        </div>
                        <div id="formDataContainer" class="file-input-container container-hidden">
                            <div id="formDataRows"></div>
                            <button class="add-row-btn" onclick="addFormDataRow()">添加新行</button>
                        </div>
                        <div id="formContainer" class="container-hidden container-margin-top">
                            <div id="formRows"></div>
                            <button onclick="addFormRow()" class="add-row-btn">添加表單項</button>
                        </div>
                        <div id="wsControls" class="container-hidden container-margin-top">
                            <input type="text" id="wsSendInput" placeholder="輸入要發送的消息" class="input-ws-send">
                            <button id="wsSendBtn" class="add-row-btn">發送</button>
                            <button id="wsCloseBtn" class="add-row-btn">關閉連接</button>
                        </div>
                        <div id="wsBodyContainer" class="container-hidden container-margin-top">
                            <div id="wsBodyRows"></div>
                            <div class="ws-body-actions">
                                <button class="add-row-btn" onclick="addWsBodyRow()" type="button">添加行</button>
                                <button class="add-row-btn" onclick="if (currentWS) currentWS.close();"
                                    type="button">斷開連接</button>
                                <button class="add-row-btn" onclick="sendWsBody()" type="button">發送</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="response-section">
                    <div class="response-info" id="responseInfo"></div>
                    <div class="response-tabs">
                        <div class="response-tab active" onclick="switchResponseTab('headers')">響應頭</div>
                        <div class="response-tab" onclick="switchResponseTab('body')">響應體</div>
                    </div>
                    <div id="headersContent" class="response-tab-content active">
                        <table class="headers-table" id="responseHeaders">
                            <thead>
                                <tr>
                                    <th>名稱</th>
                                    <th>值</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="bodyContent" class="response-tab-content">
                        <div class="response-actions">
                            <button onclick="copyResponse()">覆制響應內容</button>
                            <button onclick="clearResponse()">清空響應內容</button>
                            <button id="formatJsonBtn" onclick="formatJsonResponse()"
                                class="container-hidden">格式化JSON</button>
                            <button id="copyFormattedBtn" onclick="copyFormattedJson()"
                                class="container-hidden">覆制格式化JSON</button>
                        </div>
                        <div id="jsonFormattedContainer" class="container-hidden"></div>
                        <textarea id="responseBody" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="dialogOverlay"></div>
    <div class="settings-dialog" id="settingsDialog">
        <h3>請求配置</h3>
        <div class="settings-group">

            <label>缺省請求協議 (default_protocol)</label>
            <select id="settingDefaultProtocol">
                <option value="http">http</option>
                <option value="https">https</option>
                <option value="ws">ws</option>
                <option value="wss">wss</option>
            </select>

            <label>是否驗證SSL (verify_ssl)</label>
            <select id="settingVerifySSL">
                <option value="Y">Y - 驗證SSL</option>
                <option value="N">N - 不驗證SSL</option>
            </select>

            <label>是否自動跟隨重定向 (follow_redirect)</label>
            <select id="settingFollowRedirect">
                <option value="Y">Y - 自動跟隨</option>
                <option value="N">N - 不跟隨</option>
            </select>

            <label>請求超時時間 (秒, time_out)</label>
            <input type="number" id="settingTimeout" min="0" placeholder="0為不超時" class="setting-input">

            <label>請求重試次數 (retry_count)</label>
            <input type="number" id="settingRetryCount" min="0" placeholder="0為不重試" class="setting-input">

            <label>請求重試間隔 (秒, retry_delay)</label>
            <input type="number" id="settingRetryDelay" min="0" placeholder="0為無間隔" class="setting-input">

            <label>SSE事件類型列表 (逗號分隔)</label>
            <input type="text" id="settingSseEventTypes" placeholder="例如: update,info,warn" class="setting-input">

            <hr class="divider">

            <label>緩存策略 (cache)</label>
            <select id="settingCache">
                <option value="default">default - 默認，先在緩存里面尋找匹配的請求</option>
                <option value="no-store">no-store - 直接請求遠程服務器，不更新緩存</option>
                <option value="reload">reload - 直接請求遠程服務器，更新緩存</option>
                <option value="no-cache">no-cache - 將服務器資源跟本地緩存進行比較</option>
                <option value="force-cache">force-cache - 緩存優先</option>
                <option value="only-if-cached">only-if-cached - 只檢查緩存</option>
            </select>

            <label>請求模式 (mode)</label>
            <select id="settingMode">
                <option value="cors">cors - 允許跨域請求</option>
                <option value="same-origin">same-origin - 只允許同源請求</option>
                <option value="no-cors">no-cors - 僅限簡單請求方法和標頭</option>
                <option value="navigate">navigate - navigate</option>
            </select>

            <label>發送憑證 (credentials)</label>
            <select id="settingCredentials">
                <option value="same-origin">same-origin - 同源發送Cookie</option>
                <option value="include">include - 同源和跨域都發送Cookie</option>
                <option value="omit">omit - 不發送Cookie</option>
            </select>

            <label>重定向處理 (redirect)</label>
            <select id="settingRedirect">
                <option value="follow">follow - 自動跟隨跳轉</option>
                <option value="error">error - 跳轉時報錯</option>
                <option value="manual">manual - 手動處理跳轉</option>
            </select>

            <label>Referrer 策略 (referrerPolicy)</label>
            <select id="settingReferrerPolicy">
                <option value="no-referrer-when-downgrade">no-referrer-when-downgrade - 默認規則</option>
                <option value="no-referrer">no-referrer - 不發送Referrer</option>
                <option value="origin">origin - 只發送域名</option>
                <option value="origin-when-cross-origin">origin-when-cross-origin - 跨域時只發送域名</option>
                <option value="same-origin">same-origin - 僅同源發送</option>
                <option value="strict-origin">strict-origin - 安全降級時不發送</option>
                <option value="strict-origin-when-cross-origin">strict-origin-when-cross-origin - 安全跨域規則</option>
                <option value="unsafe-url">unsafe-url - 總是發送完整URL</option>
            </select>

            <label>Referrer</label>
            <select id="settingReferrer">
                <option value="about:client">about:client - 默認行為</option>
                <option value="">空 - 不發送referrer</option>
                <option value="custom">自定義</option>
            </select>
            <input type="text" id="settingReferrerCustom" placeholder="自定義referrer URL" class="setting-input-integrity">

            <label>完整性校驗 (integrity)</label>
            <input type="text" id="settingIntegrity" placeholder="輸入哈希值" class="setting-input">

            <label>保持連接 (keepalive)</label>
            <select id="settingKeepalive">
                <option value="false">false - 默認</option>
                <option value="true">true - 保持連接</option>
            </select>
        </div>
        <div class="dialog-buttons">
            <button onclick="closeSettings()">取消</button>
            <button onclick="saveSettings()" class="btn-primary">保存配置</button>
        </div>
    </div>

    <script>
        /**
         * 全局變量：是否使用代理模式
         * @type {boolean}
         */
        let useProxy = false;

        /**
         * 初始化代理模式狀態
         * 頁面加載時請求 /api/mode 接口獲取當前運行模式
         * @returns {Promise<void>}
         */
        async function initUseProxy() {
            try {
                const modeResp = await fetch('/api/mode');
                if (modeResp.ok) {
                    const modeData = await modeResp.json();
                    if (modeData && modeData.mode === 'proxy') {
                        useProxy = true;
                    } else {
                        useProxy = false;
                    }
                } else {
                    useProxy = false;
                }
            } catch (e) {
                useProxy = false;
            }
        }

        /**
         * 切換請求標簽頁
         * @param {string} tabName - 標簽頁名稱，可選值：'headers' 或 'body'
         */
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const selectedTab = document.querySelector(`.tab:nth-child(${tabName === 'headers' ? '1' : '2'})`);
            const selectedContent = document.getElementById(`${tabName}Tab`);

            selectedTab.classList.add('active');
            selectedContent.classList.add('active');
        }

        /**
         * 添加請求頭行
         * 在請求頭列表中添加一個新的請求頭輸入行
         */
        function addHeader() {
            const headerRow = document.createElement('div');
            headerRow.className = 'header-row';
            headerRow.innerHTML = `
                <input type="checkbox" checked>
                <input type="text" placeholder="Header名稱"/>
                <input type="text" placeholder="Header值"/>
                <input type="text" placeholder="備注" class="header-remark input-remark"/>
                <button class="remove-btn" onclick="removeHeader(this)">刪除</button>
            `;
            document.getElementById('headersList').appendChild(headerRow);
        }

        /**
         * 刪除請求頭行
         * @param {HTMLElement} button - 刪除按鈕元素
         */
        function removeHeader(button) {
            button.parentElement.remove();
        }

        /**
         * 更新請求體類型
         * 根據選擇的請求體類型顯示對應的容器，隱藏其他容器
         * @param {string} type - 請求體類型，可選值：'none', 'json', 'text', 'binary', 'form', 'formdata', 'websocket'
         */
        function updateBodyType(type) {
            const jsonBodyContainer = document.getElementById('jsonBodyContainer');
            const textBodyContainer = document.getElementById('textBodyContainer');
            const binaryBodyContainer = document.getElementById('binaryBodyContainer');
            const formDataContainer = document.getElementById('formDataContainer');
            const formContainer = document.getElementById('formContainer');
            const wsControls = document.getElementById('wsControls');
            const wsBodyContainer = document.getElementById('wsBodyContainer');

            // 隱藏所有容器
            jsonBodyContainer.style.display = 'none';
            textBodyContainer.style.display = 'none';
            binaryBodyContainer.style.display = 'none';
            formDataContainer.style.display = 'none';
            formContainer.style.display = 'none';
            wsControls.style.display = 'none';
            wsBodyContainer.style.display = 'none';

            switch (type) {
                case 'json':
                    jsonBodyContainer.style.display = 'block';
                    // 如果沒有行，添加一個默認行
                    if (document.getElementById('jsonBodyRows').children.length === 0) {
                        addJsonBodyRow();
                    }
                    break;
                case 'text':
                    textBodyContainer.style.display = 'block';
                    // 如果沒有行，添加一個默認行
                    if (document.getElementById('textBodyRows').children.length === 0) {
                        addTextBodyRow();
                    }
                    break;
                case 'binary':
                    binaryBodyContainer.style.display = 'block';
                    // 如果沒有行，添加一個默認行
                    if (document.getElementById('binaryBodyRows').children.length === 0) {
                        addBinaryBodyRow();
                    }
                    break;
                case 'form':
                    formContainer.style.display = 'block';
                    break;
                case 'formdata':
                    formDataContainer.style.display = 'block';
                    break;
                case 'websocket':
                    wsBodyContainer.style.display = 'block';
                    if (document.getElementById('wsBodyRows').children.length === 0) {
                        addWsBodyRow();
                    }
                    break;
                case 'none':
                default:
                    // 無請求體，所有容器都隱藏
                    break;
            }
        }

        /**
         * 處理FormData文件輸入變化
         * 為FormData文件輸入框提供文件預覽功能
         * @param {Event} e - 文件輸入變化事件
         */
        function handleFormDataFileChange(e) {
            const filePreview = e.target.nextElementSibling;
            filePreview.innerHTML = '';
            for (let file of e.target.files) {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <span>${file.name}</span>
                    <small>(${(file.size / 1024).toFixed(2)} KB)</small>
                `;
                filePreview.appendChild(item);
            }
        }

        /**
         * 處理Binary請求體文件輸入變化
         * 為Binary請求體文件輸入框提供文件預覽功能
         * @param {Event} e - 文件輸入變化事件
         */
        function handleBinaryFileChange(e) {
            const file = e.target.files[0];
            const filePreview = e.target.nextElementSibling;
            if (file) {
                filePreview.innerHTML = `
                    <div class="file-preview-item">
                        <span>${file.name}</span>
                        <small>(${(file.size / 1024).toFixed(2)} KB)</small>
                    </div>
                `;
            } else {
                filePreview.innerHTML = '';
            }
        }

        /**
         * 創建JSON請求體行
         * 創建一個包含radio選擇、textarea輸入、備注和刪除按鈕的JSON請求體行
         * @returns {HTMLElement} 創建的JSON請求體行元素
         */
        function createJsonBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="jsonBodyRadio">
                <div class="body-content">
                    <textarea placeholder="{}" class="textarea-body"></textarea>
                </div>
                <textarea placeholder="備注" class="body-remark"></textarea>
                <button class="remove-btn" onclick="removeBodyRow(this, 'json')">刪除</button>
            `;
            return row;
        }

        /**
         * 創建Text請求體行
         * 創建一個包含radio選擇、textarea輸入、備注和刪除按鈕的Text請求體行
         * @returns {HTMLElement} 創建的Text請求體行元素
         */
        function createTextBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="textBodyRadio">
                <div class="body-content">
                    <textarea placeholder="text" class="textarea-body"></textarea>
                </div>
                <textarea placeholder="備注" class="body-remark"></textarea>
                <button class="remove-btn" onclick="removeBodyRow(this, 'text')">刪除</button>
            `;
            return row;
        }

        /**
         * 創建Binary請求體行
         * 創建一個包含radio選擇、文件輸入、備注和刪除按鈕的Binary請求體行
         * @returns {HTMLElement} 創建的Binary請求體行元素
         */
        function createBinaryBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="binaryBodyRadio">
                <div class="body-content">
                    <input type="file" class="file-input-binary" onchange="handleBinaryFileChange(event)">
                    <div class="file-preview"></div>
                </div>
                <input type="text" placeholder="備注" class="body-remark">
                <button class="remove-btn" onclick="removeBodyRow(this, 'binary')">刪除</button>
            `;
            return row;
        }

        /**
         * 添加JSON請求體行
         * 在JSON請求體容器中添加一個新的JSON請求體行，如果是第一行則自動選中
         */
        function addJsonBodyRow() {
            const container = document.getElementById('jsonBodyRows');
            const row = createJsonBodyRow();
            container.appendChild(row);
            // 如果是第一行，自動選中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 添加Text請求體行
         * 在Text請求體容器中添加一個新的Text請求體行，如果是第一行則自動選中
         */
        function addTextBodyRow() {
            const container = document.getElementById('textBodyRows');
            const row = createTextBodyRow();
            container.appendChild(row);
            // 如果是第一行，自動選中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 添加Binary請求體行
         * 在Binary請求體容器中添加一個新的Binary請求體行，如果是第一行則自動選中
         */
        function addBinaryBodyRow() {
            const container = document.getElementById('binaryBodyRows');
            const row = createBinaryBodyRow();
            container.appendChild(row);
            // 如果是第一行，自動選中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 刪除請求體行
         * 刪除指定的請求體行，如果刪除的是選中的行且還有其他行，則選中第一行
         * 如果沒有行了，則添加一個默認行
         * @param {HTMLElement} button - 刪除按鈕元素
         * @param {string} type - 請求體類型，用於確定添加哪種類型的默認行
         */
        function removeBodyRow(button, type) {
            const row = button.closest('.body-row');
            const container = row.parentElement;
            const wasSelected = row.querySelector('input[type="radio"]').checked;

            row.remove();

            // 如果刪除的是選中的行，且還有其他行，則選中第一行
            if (wasSelected && container.children.length > 0) {
                container.children[0].querySelector('input[type="radio"]').checked = true;
            }

            // 如果沒有行了，添加一個默認行
            if (container.children.length === 0) {
                switch (type) {
                    case 'json':
                        addJsonBodyRow();
                        break;
                    case 'text':
                        addTextBodyRow();
                        break;
                    case 'binary':
                        addBinaryBodyRow();
                        break;
                }
            }
        }

        /**
         * 創建FormData行
         * 創建一個包含覆選框、參數名、類型選擇、值輸入、備注和刪除按鈕的FormData行
         * @returns {HTMLElement} 創建的FormData行元素
         */
        function createFormDataRow() {
            const row = document.createElement('div');
            row.className = 'formdata-row';
            row.innerHTML = `
                <input type="checkbox" checked>
                <input type="text" class="formdata-key" placeholder="參數名稱">
                <select class="formdata-type select-formdata-type" onchange="handleTypeChange(this)">
                    <option value="text">文本</option>
                    <option value="file">文件</option>
                </select>
                <div class="formdata-value">
                    <input type="text" class="text-input" placeholder="文本值">
                    <input type="file" class="file-input" multiple onchange="handleFormDataFileChange(event)">
                    <div class="file-preview"></div>
                </div>
                <input type="text" placeholder="備注" class="formdata-remark"/>
                <button class="remove-btn" onclick="removeFormDataRow(this)">刪除</button>
            `;
            return row;
        }

        /**
         * 添加FormData行
         * 在FormData容器中添加一個新的FormData行
         */
        function addFormDataRow() {
            const container = document.getElementById('formDataRows');
            const row = createFormDataRow();
            container.appendChild(row);
        }

        /**
         * 刪除FormData行
         * @param {HTMLElement} button - 刪除按鈕元素
         */
        function removeFormDataRow(button) {
            button.closest('.formdata-row').remove();
        }

        /**
         * 處理FormData類型變化
         * 根據選擇的類型（文本/文件）顯示對應的輸入控件
         * @param {HTMLSelectElement} select - 類型選擇下拉框元素
         */
        function handleTypeChange(select) {
            const row = select.closest('.formdata-row');
            const textInput = row.querySelector('.text-input');
            const fileInput = row.querySelector('.file-input');
            const filePreview = row.querySelector('.file-preview');

            if (select.value === 'text') {
                textInput.style.display = 'block';
                fileInput.style.display = 'none';
                filePreview.style.display = 'none';
                fileInput.value = ''; // 清除已選文件
            } else {
                textInput.style.display = 'none';
                fileInput.style.display = 'block';
                filePreview.style.display = 'block';
            }
        }

        /**
         * 添加表單行
         * 在表單容器中添加一個新的表單參數行
         */
        function addFormRow() {
            const formRow = document.createElement('div');
            formRow.className = 'header-row';
            formRow.innerHTML = `
                <input type="checkbox" checked>
                <input type="text" placeholder="參數名稱"/>
                <input type="text" placeholder="參數值"/>
                <input type="text" placeholder="備注" class="form-remark input-remark"/>
                <button class="remove-btn" onclick="removeFormRow(this)">刪除</button>
            `;
            document.getElementById('formRows').appendChild(formRow);
        }

        /**
         * 刪除表單行
         * @param {HTMLElement} button - 刪除按鈕元素
         */
        function removeFormRow(button) {
            button.closest('.header-row').remove();
        }

        /**
         * 獲取當前選擇的請求體類型
         * @returns {string} 請求體類型，如果沒有選擇則返回 'none'
         */
        function getBodyType() {
            const checkedRadio = document.querySelector('input[name="bodyType"]:checked');
            return checkedRadio ? checkedRadio.value : 'none';
        }

        /**
         * 構建請求頭
         * 獲取並處理用戶自定義請求頭和全局請求頭
         * @returns {Promise<Object>} 處理後的請求頭對象
         */
        async function buildRequestHeaders() {
            // 獲取用戶自定義請求頭
            const customHeaders = {};
            document.querySelectorAll('#headersList .header-row').forEach(row => {
                const inputs = row.getElementsByTagName('input');
                const isEnabled = inputs[0]?.checked;
                const key = inputs[1]?.value;
                const value = inputs[2]?.value;

                if (isEnabled && key) {
                    // 替換header的key和value中的變量
                    const normalizedKey = replaceVariables(key)?.trim();
                    const normalizedValue = replaceVariables(value || '')?.trim();

                    // 驗證header名稱
                    if (normalizedKey) {
                        if (!/^[a-zA-Z0-9\-]+$/.test(normalizedKey)) {
                            throw new Error(`無效的請求頭名稱: ${normalizedKey}`);
                        }

                        // 規範化header名稱（首字母大寫，其余小寫）
                        const finalKey = normalizedKey.split('-').map(part =>
                            part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                        ).join('-');
                        customHeaders[finalKey] = normalizedValue;
                    }
                }
            });

            // 獲取全局請求頭並規範化
            const globalHeaders = {};
            const rawGlobalHeaders = getGlobalHeaders();
            for (const [key, value] of Object.entries(rawGlobalHeaders)) {
                if (key) {
                    const normalizedKey = key.split('-').map(part =>
                        part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                    ).join('-');
                    globalHeaders[normalizedKey] = value;
                }
            }

            // 合並請求頭，用戶自定義的優先級更高
            const headers = { ...globalHeaders, ...customHeaders };

            // 驗證所有請求頭名稱
            for (const key of Object.keys(headers)) {
                if (key && !/^[a-zA-Z0-9\-]+$/.test(key)) {
                    throw new Error(`無效的請求頭名稱: ${key}`);
                }
            }

            return headers;
        }

        function normalizeUrlWithProtocol(url, protocol) {
            if (!url) return url;
            // 只判斷常用的四種協議
            if (/^(https?|wss?):\/\//i.test(url)) return url;
            if (url.startsWith('//')) return protocol + ':' + url;
            return protocol + '://' + url;
        }

        /**
         * 處理代理請求
         * 構建FormData並發送到代理服務器
         * @param {string} url - 目標URL
         * @param {string} method - 請求方法
         * @param {string} bodyType - 請求體類型
         * @param {Object} headers - 請求頭
         * @param {Object} settings - 請求設置
         * @param {boolean} download - 是否為下載請求
         * @returns {Promise<void>}
         */
        async function handleProxyRequest(url, method, bodyType, headers, settings, download) {
            const formData = new FormData();
            formData.append('url', url);
            formData.append('method', method);
            formData.append('body_type', bodyType === 'formdata' ? 'form-data' : (bodyType === 'form' ? 'x-www-form-urlencoded' : bodyType));

            const headersArr = Object.entries(headers).map(([name, value]) => ({ name, value }));
            formData.append('headers', JSON.stringify(headersArr));
            formData.append('time_out', settings.timeout || '0');
            formData.append('verify_ssl', settings.verify_ssl || 'N');
            formData.append('follow_redirect', settings.follow_redirect || 'N');
            formData.append('retry_count', settings.retry_count || '0');
            formData.append('retry_delay', settings.retry_delay || '0');

            // 處理body和文件
            const filesInfo = [];
            await processRequestBody(formData, bodyType, filesInfo);

            if (filesInfo.length > 0) {
                formData.append('file_info', JSON.stringify(filesInfo));
            }

            try {
                const startTime = Date.now();
                const response = await fetch('/api/forward', {
                    method: 'POST',
                    body: formData
                });
                const duration = Date.now() - startTime;
                const contentType = response.headers.get('content-type');

                // SSE流式處理
                if (contentType?.includes('text/event-stream')) {
                    await handleSSEFetchResponse(response);
                    saveRequestToHistory();
                    return;
                }

                if (download) {
                    await handleDownloadResponse(response, contentType);
                } else {
                    await handleNormalResponse(response, duration, contentType);
                }

                await updateResponseHeaders(response);
                saveRequestToHistory();
            } catch (error) {
                await handleRequestError(error);
            }
        }

        /**
         * 處理請求體
         * 根據請求體類型處理不同的數據
         * @param {FormData} formData - FormData對象
         * @param {string} bodyType - 請求體類型
         * @param {Array} filesInfo - 文件信息數組
         * @returns {Promise<void>}
         */
        async function processRequestBody(formData, bodyType, filesInfo) {
            switch (bodyType) {
                case 'formdata': {
                    const formDataRows = document.querySelectorAll('.formdata-row');
                    for (const row of formDataRows) {
                        const isEnabled = row.querySelector('input[type="checkbox"]')?.checked;
                        if (!isEnabled) continue;

                        const key = row.querySelector('.formdata-key')?.value;
                        const type = row.querySelector('.formdata-type')?.value;
                        if (!key) continue;

                        if (type === 'text') {
                            const value = row.querySelector('.text-input')?.value || '';
                            formData.append(key, value);
                        } else if (type === 'file') {
                            const fileInput = row.querySelector('.file-input');
                            if (fileInput?.files.length > 0) {
                                for (const file of fileInput.files) {
                                    formData.append('files', file);
                                    filesInfo.push({ field_name: key, file_name: file.name });
                                }
                            } else {
                                formData.append(key, '');
                            }
                        }
                    }
                    break;
                }
                case 'form': {
                    const formRows = document.querySelectorAll('#formRows .header-row');
                    for (const row of formRows) {
                        const inputs = row.getElementsByTagName('input');
                        const isEnabled = inputs[0]?.checked;
                        const key = inputs[1]?.value;
                        if (isEnabled && key) {
                            formData.append(key, inputs[2]?.value || '');
                        }
                    }
                    break;
                }
                case 'json':
                case 'text':
                case 'xml': {
                    const bodyContent = await getRequestBody(bodyType);
                    if (bodyContent) {
                        formData.append('body', bodyContent);
                    }
                    break;
                }
                case 'binary': {
                    const selectedRow = document.querySelector('#binaryBodyRows input[type="radio"]:checked');
                    if (selectedRow) {
                        const fileInput = selectedRow.closest('.body-row').querySelector('input[type="file"]');
                        if (fileInput?.files.length > 0) {
                            const file = fileInput.files[0];
                            formData.append('files', file);
                            filesInfo.push({ field_name: 'files', file_name: file.name });
                        }
                    }
                    break;
                }
            }
        }

        /**
         * 更新響應頭顯示
         * @param {Response} response - fetch響應對象
         * @returns {Promise<void>}
         */
        async function updateResponseHeaders(response) {
            const responseHeadersTable = document.getElementById('responseHeaders')?.getElementsByTagName('tbody')[0];
            if (!responseHeadersTable) return;

            responseHeadersTable.innerHTML = '';

            const allHeaders = response.headers.get('X-Response-Headers');
            if (allHeaders) {
                try {
                    const headers = JSON.parse(allHeaders);
                    for (const [key, values] of Object.entries(headers)) {
                        const row = responseHeadersTable.insertRow();
                        row.insertCell(0).textContent = key;
                        row.insertCell(1).textContent = Array.isArray(values) ? values.join(', ') : values;
                    }
                } catch (e) {
                    console.error('解析響應頭失敗:', e);
                }
            } else {
                // 回退到原始方式
                response.headers.forEach((value, key) => {
                    const row = responseHeadersTable.insertRow();
                    row.insertCell(0).textContent = key;
                    row.insertCell(1).textContent = value;
                });
            }
        }

        /**
         * 處理請求錯誤
         * @param {Error} error - 錯誤對象
         * @returns {Promise<void>}
         */
        async function handleRequestError(error) {
            const responseInfo = document.getElementById('responseInfo');
            const responseBody = document.getElementById('responseBody');
            const responseHeaders = document.getElementById('responseHeaders');

            if (responseInfo) {
                responseInfo.innerHTML = `請求錯誤: ${error.message}`;
            }
            if (responseBody) {
                responseBody.value = '';
            }
            if (responseHeaders) {
                const tbody = responseHeaders.getElementsByTagName('tbody')[0];
                if (tbody) {
                    tbody.innerHTML = '';
                }
            }
        }

        /**
         * 處理WebSocket/SSE請求
         * @param {string} url - 目標URL
         * @param {string} method - 請求方法 (WS/SSE)
         * @param {Object} headers - 請求頭
         * @param {Object} settings - 請求設置
         * @returns {Promise<void>}
         */
        async function handleWSRequest(url, method, headers, settings) {
            // 斷開已有連接
            if (currentWS) {
                try { currentWS.close(); } catch (e) { }
                currentWS = null;
            }
            if (currentSSE) {
                try { currentSSE.close(); } catch (e) { }
                currentSSE = null;
            }

            // 清空響應區域
            const responseInfo = document.getElementById('responseInfo');
            const responseBody = document.getElementById('responseBody');
            const responseHeaders = document.getElementById('responseHeaders');

            if (responseInfo) responseInfo.innerHTML = '';
            if (responseBody) responseBody.value = '';
            if (responseHeaders) {
                const tbody = responseHeaders.getElementsByTagName('tbody')[0];
                if (tbody) tbody.innerHTML = '';
            }

            // 構造 formData
            const formData = new FormData();
            formData.append('url', url);
            formData.append('method', method);
            formData.append('body_type', 'none');
            const headersArr = Object.entries(headers).map(([name, value]) => ({ name, value }));
            formData.append('headers', JSON.stringify(headersArr));
            formData.append('time_out', settings.timeout || '0');
            formData.append('verify_ssl', settings.verify_ssl || 'N');
            formData.append('follow_redirect', settings.follow_redirect || 'N');
            formData.append('retry_count', settings.retry_count || '0');
            formData.append('retry_delay', settings.retry_delay || '0');

            try {
                const resp = await fetch('/api/forward', { method: 'POST', body: formData });
                const data = await resp.json();
                if (data.code !== 0) {
                    if (responseInfo) {
                        responseInfo.innerHTML = '連接失敗: ' + (data.msg || '未知錯誤');
                    }
                    return;
                }

                const connect_id = data.connect_id;
                if (method === 'WS') {
                    await establishWSConnection(connect_id);
                } else if (method === 'SSE') {
                    await establishSSEConnection(connect_id);
                }
            } catch (err) {
                if (responseInfo) {
                    responseInfo.innerHTML = '請求錯誤: ' + (err.message || err);
                }
                console.error('WS/SSE請求錯誤:', err);
            }
        }

        /**
         * 建立WebSocket連接
         * @param {string} connect_id - 連接ID
         * @returns {Promise<void>}
         */
        async function establishWSConnection(connect_id) {
            const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${wsProto}://${location.host}/api/forward-ws?connect_id=${connect_id}`;
            const ws = new WebSocket(wsUrl);
            currentWS = ws;

            const responseBody = document.getElementById('responseBody');
            if (responseBody) responseBody.value = '';

            ws.onopen = function () {
                const responseInfo = document.getElementById('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'WebSocket 連接已建立';
                }
                saveRequestToHistory();
            };

            ws.onmessage = function (e) {
                // 處理WS響應頭
                try {
                    if (typeof e.data === 'string') {
                        const obj = JSON.parse(e.data);
                        if (obj.type === 'headers' && obj.headers) {
                            updateWSResponseHeaders(obj.headers);
                            return;
                        }
                    }

                } catch (err) {
                    console.warn('解析WS響應頭失敗:', err);
                }

                // 處理普通消息
                const responseBody = document.getElementById('responseBody');
                if (!responseBody) return;

                if (typeof e.data === 'string') {
                    // 文本消息
                    responseBody.value += e.data + '\n';
                } else if (e.data instanceof Blob) {
                    // Blob 類型，轉為 base64 或 hex 或 utf-8 字符串
                    const reader = new FileReader();
                    reader.onload = function () {
                        // 你可以選擇顯示為 base64、hex 或 utf-8
                        // 這里是 base64
                        /*
                        const base64 = btoa(
                            new Uint8Array(reader.result)
                                .reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                        responseBody.value += '[Blob] base64: ' + base64 + '\n';
                        */
                        responseBody.value += '[Blob] data\n';

                    };
                    reader.readAsArrayBuffer(e.data);
                } else if (e.data instanceof ArrayBuffer) {
                    // ArrayBuffer 類型，轉為 hex 或 base64
                    /*
                    const arr = new Uint8Array(e.data);
                    const hex = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join(' ');
                    responseBody.value += '[ArrayBuffer] hex: ' + hex + '\n';
                    */
                    responseBody.value += '[ArrayBuffer] data\n';
                } else {
                    responseBody.value += '[Unknown WS message type]\n';
                }
            };

            ws.onerror = function (e) {
                const responseInfo = document.getElementById('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'WebSocket 錯誤';
                }
            };

            ws.onclose = function () {
                const responseInfo = document.getElementById('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'WebSocket 連接已關閉';
                }
                currentWS = null;
            };

            // 綁定發送/關閉按鈕
            bindWSButtons(ws);
        }

        /**
         * 建立SSE連接
         * @param {string} connect_id - 連接ID
         * @returns {Promise<void>}
         */
        async function establishSSEConnection(connect_id) {
            const sseUrl = `/api/forward-sse?connect_id=${connect_id}`;
            const es = new EventSource(sseUrl);
            currentSSE = es;

            const responseBody = document.getElementById('responseBody');
            if (responseBody) responseBody.value = '';

            const responseInfo = document.getElementById('responseInfo');
            if (responseInfo) {
                responseInfo.innerHTML = 'SSE 連接已建立';
            }
            saveRequestToHistory();

            // 監聽x-web-curl-headers事件，專門處理響應頭
            es.addEventListener('x-web-curl-headers', function (e) {
                try {
                    const obj = JSON.parse(e.data);
                    updateWSResponseHeaders(obj);
                } catch (err) {
                    console.warn('解析SSE響應頭失敗:', err);
                }
            });

            es.onmessage = function (e) {
                const responseBody = document.getElementById('responseBody');
                if (responseBody) {
                    responseBody.value += `[message] ${e.data || ''}\n`;
                }
            };

            // 注冊用戶配置的SSE事件類型監聽器
            const settings = getRequestSettings();
            if (settings.sse_event_types) {
                const sseEventTypeList = settings.sse_event_types.split(',').map(type => type.trim()).filter(type => type);
                sseEventTypeList.forEach(type => {
                    if (type && type !== 'message' && type !== 'x-web-curl-headers') {
                        es.addEventListener(type, function (e) {
                            const responseBody = document.getElementById('responseBody');
                            if (responseBody) {
                                responseBody.value += `[${type}] ${e.data || ''}\n`;
                            }
                        });
                    }
                });
            }

            es.onerror = function (e) {
                const responseInfo = document.getElementById('responseInfo');
                if (responseInfo) {
                    responseInfo.innerHTML = 'SSE 連接已關閉';
                }
                es.close();
                currentSSE = null;
            };
        }

        /**
         * 更新WebSocket/SSE響應頭
         * @param {Object} headers - 響應頭對象
         */
        function updateWSResponseHeaders(headers) {
            const responseHeadersTable = document.getElementById('responseHeaders')?.getElementsByTagName('tbody')[0];
            if (!responseHeadersTable) return;

            responseHeadersTable.innerHTML = '';
            for (const [key, values] of Object.entries(headers)) {
                const row = responseHeadersTable.insertRow();
                row.insertCell(0).textContent = key;
                row.insertCell(1).textContent = Array.isArray(values) ? values.join(', ') : values;
            }
        }

        /**
         * 設置Content-Type並獲取請求體
         * @param {Object} headers - 請求頭對象
         * @param {string} bodyType - 請求體類型
         * @param {Object} requestOptions - 請求選項
         * @returns {Promise<void>}
         */
        async function setContentTypeAndBody(headers, bodyType, requestOptions) {
            switch (bodyType) {
                case 'form':
                    headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    break;
                case 'json':
                    headers['Content-Type'] = 'application/json';
                    break;
                case 'text':
                    // 檢查用戶是否已經設置了文本類型的 Content-Type
                    const customContentType = headers['Content-Type'];
                    if (customContentType && customContentType.startsWith('text/')) {
                        // 使用用戶自定義的 Content-Type
                        headers['Content-Type'] = customContentType;
                    } else {
                        headers['Content-Type'] = 'text/plain';
                    }
                    break;
                case 'binary':
                    headers['Content-Type'] = 'application/octet-stream';
                    break;
            }

            requestOptions.body = await getRequestBody(bodyType);
        }

        /**
         * 綁定WebSocket按鈕事件
         * @param {WebSocket} ws - WebSocket實例
         */
        function bindWSButtons(ws) {
            const wsSendBtn = document.getElementById('wsSendBtn');
            const wsCloseBtn = document.getElementById('wsCloseBtn');
            const wsSendInput = document.getElementById('wsSendInput');

            if (wsSendBtn) {
                wsSendBtn.onclick = function () {
                    const msg = wsSendInput?.value || '';
                    if (ws && ws.readyState === 1) {
                        try {
                            ws.send(msg);
                        } catch (err) {
                            console.error('發送WS消息失敗:', err);
                        }
                    }
                };
            }

            if (wsCloseBtn) {
                wsCloseBtn.onclick = function () {
                    if (ws && ws.readyState === 1) {
                        try {
                            ws.close();
                        } catch (err) {
                            console.error('關閉WS連接失敗:', err);
                        }
                    }
                };
            }
        }

        /**
         * 獲取請求體內容
         * 根據請求體類型獲取對應的請求體數據
         * @param {string} bodyType - 請求體類型
         * @returns {Promise<string|FormData|ArrayBuffer|null>} 請求體數據，根據類型返回不同格式
         * @throws {Error} 當JSON格式不正確或未選擇文件時拋出錯誤
         */
        async function getRequestBody(bodyType) {
            const getSelectedRow = (selector) => {
                const row = document.querySelector(selector);
                if (!row) {
                    throw new Error(`請選擇一個${bodyType}請求體`);
                }
                return row;
            };

            switch (bodyType) {
                case 'json': {
                    try {
                        const selectedRow = getSelectedRow('#jsonBodyRows input[type="radio"]:checked');
                        const jsonText = selectedRow.closest('.body-row').querySelector('textarea')?.value || '';
                        // 驗證JSON格式的合法性
                        JSON.parse(jsonText);
                        return jsonText;
                    } catch (e) {
                        throw new Error(`JSON格式不正確: ${e.message}`);
                    }
                }
                case 'text': {
                    const selectedTextRow = getSelectedRow('#textBodyRows input[type="radio"]:checked');
                    return selectedTextRow.closest('.body-row').querySelector('textarea')?.value || '';
                }
                case 'binary': {
                    const selectedBinaryRow = getSelectedRow('#binaryBodyRows input[type="radio"]:checked');
                    const fileInput = selectedBinaryRow.closest('.body-row').querySelector('input[type="file"]');
                    if (!fileInput?.files.length) {
                        throw new Error('請選擇要上傳的文件');
                    }
                    return await fileInput.files[0].arrayBuffer();
                }
                case 'form': {
                    const formData = new URLSearchParams();
                    document.querySelectorAll('#formRows .header-row').forEach((row) => {
                        const inputs = row.getElementsByTagName('input');
                        const isEnabled = inputs[0]?.checked;
                        const key = inputs[1]?.value;
                        if (isEnabled && key) {
                            formData.append(key, inputs[2]?.value || '');
                        }
                    });
                    return formData.toString();
                }
                case 'formdata': {
                    const multipartFormData = new FormData();
                    const formDataRows = document.querySelectorAll('.formdata-row');
                    for (const row of formDataRows) {
                        const isEnabled = row.querySelector('input[type="checkbox"]')?.checked;
                        if (!isEnabled) continue;

                        const key = row.querySelector('.formdata-key')?.value;
                        const type = row.querySelector('.formdata-type')?.value;
                        if (!key) continue;

                        if (type === 'text') {
                            const value = row.querySelector('.text-input')?.value || '';
                            multipartFormData.append(key, value);
                        } else if (type === 'file') {
                            const fileInput = row.querySelector('.file-input');
                            if (fileInput?.files.length > 0) {
                                for (const file of fileInput.files) {
                                    multipartFormData.append(key, file);
                                }
                            } else {
                                multipartFormData.append(key, '');
                            }
                        }
                    }
                    return multipartFormData;
                }
                default:
                    return null;
            }
        }

        /**
         * 處理下載類型的HTTP響應
         * 將響應內容保存為文件並在頁面上顯示相關信息
         * @param {Response} response - fetch API 的響應對象
         * @param {string} contentType - 響應內容類型
         * @returns {Promise<void>}
         * @throws {Error} 當HTTP響應狀態不是ok時拋出
         */
        async function handleDownloadResponse(response, contentType) {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 提取文件名
            let filename = '';
            const contentDisposition = response.headers.get('content-disposition');
            if (contentDisposition?.includes('filename=')) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch?.[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                    try {
                        filename = decodeURIComponent(filename);
                    } catch (e) {
                        console.warn('文件名解碼失敗:', e);
                    }
                }
            }

            if (!filename) {
                const extension = contentType?.split('/').pop()?.split(';')[0] || 'txt';
                filename = `downloaded_file.${extension}`;
            }

            const blob = await response.blob();
            const downloadUrl = URL.createObjectURL(blob);

            // 使用現代下載方式
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);

            const responseInfo = document.getElementById('responseInfo');
            const responseBody = document.getElementById('responseBody');

            if (responseInfo) {
                responseInfo.innerHTML = `
                    狀態碼: ${response.status} ${response.statusText}<br>
                    文件名: ${filename}<br>
                    文件大小: ${(blob.size / 1024).toFixed(2)} KB<br>
                    內容類型: ${contentType || '未指定'}<br>
                `;
            }

            if (responseBody) {
                responseBody.value = '[二進制文件內容已下載]';
            }
        }

        /**
         * 處理普通HTTP響應（非下載）
         * 在頁面上顯示響應信息、響應體和格式化按鈕（如為JSON）
         * @param {Response} response - fetch API 的響應對象
         * @param {number} duration - 響應耗時，單位ms
         * @param {string} contentType - 響應內容類型
         * @returns {Promise<void>}
         */
        async function handleNormalResponse(response, duration, contentType) {
            const responseInfo = document.getElementById('responseInfo');
            const responseBody = document.getElementById('responseBody');

            if (responseInfo) {
                responseInfo.innerHTML = `
                    狀態碼: ${response.status} ${response.statusText}<br>
                    響應時間: ${duration}ms<br>
                    內容類型: ${contentType || '未指定'}<br>
                `;
            }

            // 重置JSON格式化狀態
            resetJsonFormatState();

            // 二進制內容類型檢測
            const binaryTypes = [
                'application/octet-stream',
                'application/pdf',
                'image/',
                'audio/',
                'video/',
                'application/zip',
                'application/x-rar'
            ];

            const isBinaryContent = contentType && binaryTypes.some(type => contentType.includes(type));

            if (isBinaryContent) {
                if (responseBody) {
                    responseBody.value = `[二進制內容] - ${contentType}\n建議使用"發送並下載"按鈕下載此內容`;
                }
            } else {
                const responseText = await response.text();
                if (responseBody) {
                    responseBody.value = responseText;
                }

                // 檢測是否為JSON響應
                const isJsonContentType = contentType?.includes('application/json');
                const isJsonFormat = responseText.trim() && (
                    responseText.trim().startsWith('{') ||
                    responseText.trim().startsWith('[')
                );

                if (isJsonContentType || (isJsonFormat && (() => {
                    try {
                        JSON.parse(responseText.trim());
                        return true;
                    } catch {
                        return false;
                    }
                })())) {
                    showJsonFormatButton();
                }
            }
        }

        /**
         * 重置JSON格式化狀態
         * 隱藏格式化容器和按鈕，顯示原始響應內容
         */
        function resetJsonFormatState() {
            const elements = {
                container: document.getElementById('jsonFormattedContainer'),
                textarea: document.getElementById('responseBody'),
                formatBtn: document.getElementById('formatJsonBtn'),
                copyBtn: document.getElementById('copyFormattedBtn')
            };

            if (elements.container) elements.container.style.display = 'none';
            if (elements.textarea) elements.textarea.style.display = 'block';
            if (elements.formatBtn) elements.formatBtn.style.display = 'none';
            if (elements.copyBtn) elements.copyBtn.style.display = 'none';

            isJsonFormatted = false;
        }

        /**
         * 顯示JSON格式化按鈕
         * 當檢測到響應為JSON格式時顯示格式化按鈕
         */
        function showJsonFormatButton() {
            const formatJsonBtn = document.getElementById('formatJsonBtn');
            if (formatJsonBtn) {
                formatJsonBtn.style.display = 'inline-block';
            }
        }

        // 全局變量，保存當前WS/SSE連接
        let currentWS = null;
        let currentSSE = null;

        // localStorage管理工具
        const StorageManager = {
            /**
             * 安全地從localStorage獲取數據
             * @param {string} key - 存儲鍵
             * @param {any} defaultValue - 默認值
             * @returns {any} 解析後的數據
             */
            get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error(`讀取localStorage失敗 [${key}]:`, error);
                    return defaultValue;
                }
            },

            /**
             * 安全地向localStorage存儲數據
             * @param {string} key - 存儲鍵
             * @param {any} value - 要存儲的數據
             */
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error(`寫入localStorage失敗 [${key}]:`, error);
                }
            },

            /**
             * 從localStorage刪除數據
             * @param {string} key - 存儲鍵
             */
            remove(key) {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.error(`刪除localStorage失敗 [${key}]:`, error);
                }
            }
        };

        /**
         * 設置請求按鈕狀態
         * @param {boolean} loading - 是否處於加載狀態
         */
        function setRequestButtonsState(loading) {
            const sendBtn = document.getElementById('sendBtn');
            const downloadBtn = document.getElementById('downloadBtn');

            if (sendBtn) {
                sendBtn.disabled = loading;
                if (loading) {
                    sendBtn.classList.add('loading');
                    sendBtn.textContent = '請求中...';
                } else {
                    sendBtn.classList.remove('loading');
                    sendBtn.textContent = '發送請求';
                }
            }

            if (downloadBtn) {
                downloadBtn.disabled = loading;
                if (loading) {
                    downloadBtn.classList.add('loading');
                    downloadBtn.textContent = '下載中...';
                } else {
                    downloadBtn.classList.remove('loading');
                    downloadBtn.textContent = '下載';
                }
            }
        }

        /**
         * 發送HTTP請求或建立WS/SSE連接
         * 根據請求方法和代理模式選擇不同的處理方式
         * @param {boolean} download - 是否為下載請求
         * @returns {Promise<void>}
         */
        async function sendRequest(download = false) {
            // 每次請求前先清空響應內容
            clearResponse();
            // 設置按鈕為加載狀態
            setRequestButtonsState(true);

            try {
                // 獲取基本請求信息
                const methodElement = document.getElementById('httpMethod');
                const urlElement = document.getElementById('url');

                if (!methodElement || !urlElement) {
                    throw new Error('無法獲取請求方法或URL');
                }

                let method = methodElement.value;
                let url = urlElement.value;
                const bodyType = getBodyType();

                // 替換URL中的變量
                url = replaceVariables(url)?.trim() || '';
                const settings = getRequestSettings();
                url = normalizeUrlWithProtocol(url, settings.default_protocol);
                if (!url) {
                    throw new Error('請輸入有效的URL');
                }

                // 獲取並處理請求頭
                const headers = await buildRequestHeaders();

                const requestOptions = {
                    method,
                    headers,
                    cache: settings.cache,
                    mode: settings.mode,
                    credentials: settings.credentials,
                    redirect: settings.redirect,
                    referrer: settings.referrer,
                    referrerPolicy: settings.referrerPolicy,
                    integrity: settings.integrity || undefined,
                    keepalive: settings.keepalive
                };

                if (useProxy && method !== 'WS' && method !== 'SSE') {
                    await handleProxyRequest(url, method, bodyType, headers, settings, download);
                    return;
                }

                // WS/SSE 邏輯
                if (useProxy && (method === 'WS' || method === 'SSE')) {
                    await handleWSRequest(url, method, headers, settings);
                    return;
                }

                // 設置Content-Type並獲取請求體
                if (bodyType !== 'none' && method !== 'GET') {
                    await setContentTypeAndBody(headers, bodyType, requestOptions);
                }

                const startTime = Date.now();
                const response = await fetch(url, requestOptions);
                const duration = Date.now() - startTime;
                const contentType = response.headers.get('content-type');

                if (download) {
                    await handleDownloadResponse(response, contentType);
                } else {
                    await handleNormalResponse(response, duration, contentType);
                }

                await updateResponseHeaders(response);
                saveRequestToHistory();
            } catch (error) {
                await handleRequestError(error);
            } finally {
                // 恢覆按鈕狀態
                setRequestButtonsState(false);
            }
        }

        /**
         * 發送請求並下載響應內容
         * @returns {Promise<void>}
         */
        async function sendRequestAndDownload() {
            // 每次請求前先清空響應內容
            clearResponse();
            await sendRequest(true);
        }

        /**
         * 切換響應標簽頁
         * @param {string} tabName - 標簽頁名稱，可選值：'headers' 或 'body'
         */
        function switchResponseTab(tabName) {
            document.querySelectorAll('.response-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.response-tab-content').forEach(content => content.classList.remove('active'));

            const selectedTab = document.querySelector(`.response-tab:nth-child(${tabName === 'headers' ? '1' : '2'})`);
            const selectedContent = document.getElementById(`${tabName}Content`);

            selectedTab.classList.add('active');
            selectedContent.classList.add('active');
        }

        /**
         * 覆制響應內容到剪貼板
         */
        async function copyResponse() {
            const responseBody = document.getElementById('responseBody');
            if (!responseBody?.value) return;

            try {
                await navigator.clipboard.writeText(responseBody.value);
                console.log('響應內容已覆制到剪貼板');
            } catch (err) {
                console.error('覆制響應內容失敗:', err);
            }
        }

        /**
         * 清空響應內容
         * 清空響應信息、響應體、響應頭，並斷開WS/SSE連接
         */
        function clearResponse() {
            const responseInfo = document.getElementById('responseInfo');
            const responseBody = document.getElementById('responseBody');
            const responseHeaders = document.getElementById('responseHeaders');

            if (responseInfo) responseInfo.innerHTML = '';
            if (responseBody) responseBody.value = '';
            if (responseHeaders) {
                const tbody = responseHeaders.getElementsByTagName('tbody')[0];
                if (tbody) tbody.innerHTML = '';
            }

            // 重置JSON格式化狀態
            resetJsonFormatState();

            // 安全關閉連接
            if (currentWS) {
                try {
                    currentWS.close();
                } catch (e) {
                    console.warn('關閉WS連接時出錯:', e);
                }
                currentWS = null;
            }
            if (currentSSE) {
                try {
                    currentSSE.close();
                } catch (e) {
                    console.warn('關閉SSE連接時出錯:', e);
                }
                currentSSE = null;
            }
        }

        // 歷史記錄相關函數
        const MAX_HISTORY_ITEMS = 50; // 最大歷史記錄數

        /**
         * 保存當前請求到歷史記錄
         * 將當前請求的所有信息（方法、URL、請求頭、請求體）保存到localStorage
         */
        function saveRequestToHistory() {
            const method = document.getElementById('httpMethod').value;
            const url = document.getElementById('url').value;
            const bodyType = getBodyType();

            // 獲取請求頭
            const headers = {};
            document.querySelectorAll('#headersList .header-row').forEach(row => {
                const inputs = row.getElementsByTagName('input');
                const isEnabled = inputs[0].checked;
                // 只要有key就保存
                if (inputs[1].value) {
                    headers[inputs[1].value] = {
                        // 如果value為空，使用空字符串
                        value: inputs[2].value || '',
                        // 保存覆選框狀態
                        enabled: isEnabled,
                        // 保存備注
                        remark: inputs[3].value || ''
                    };
                }
            });

            // 獲取請求體
            let body = null;
            if (bodyType === 'form') {
                const formData = {};
                document.querySelectorAll('#formRows .header-row').forEach((row) => {
                    const inputs = row.getElementsByTagName('input');
                    const isEnabled = inputs[0].checked;
                    // 只要有key就保存
                    if (inputs[1].value) {
                        formData[inputs[1].value] = {
                            // 如果value為空，使用空字符串
                            value: inputs[2].value || '',
                            // 保存覆選框狀態
                            enabled: isEnabled,
                            // 保存備注
                            remark: inputs[3].value || ''
                        };
                    }
                });
                body = { type: 'form', data: formData };
            } else if (bodyType === 'formdata') {
                const formDataItems = [];
                document.querySelectorAll('.formdata-row').forEach(row => {
                    const key = row.querySelector('.formdata-key').value;
                    const type = row.querySelector('.formdata-type').value;
                    const isEnabled = row.querySelector('input[type="checkbox"]').checked;
                    // 只要有key就保存
                    if (key) {
                        const value = type === 'text' ? (row.querySelector('.text-input').value || '') : null;
                        const remarkInput = row.querySelector('.formdata-remark');
                        formDataItems.push({
                            key,
                            type,
                            value,
                            enabled: isEnabled,
                            remark: remarkInput ? remarkInput.value : ''
                        });
                    }
                });
                body = { type: 'formdata', data: formDataItems };
            } else if (bodyType === 'json') {
                const jsonBodyItems = [];
                document.querySelectorAll('#jsonBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    jsonBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'json', data: jsonBodyItems };
            } else if (bodyType === 'text') {
                const textBodyItems = [];
                document.querySelectorAll('#textBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    textBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'text', data: textBodyItems };
            } else if (bodyType === 'binary') {
                const binaryBodyItems = [];
                document.querySelectorAll('#binaryBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const fileInput = row.querySelector('input[type="file"]');
                    const remark = row.querySelector('.body-remark').value;
                    // 對於文件，我們只能保存文件名，不能保存文件內容
                    const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    binaryBodyItems.push({
                        fileName,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'binary', data: binaryBodyItems };
            } else if (bodyType === 'websocket') {
                const wsBodyItems = [];
                document.querySelectorAll('#wsBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const type = row.querySelector('.ws-body-type').value;
                    let value = '';
                    if (type === 'file') {
                        const fileInput = row.querySelector('.ws-body-file');
                        value = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    } else {
                        value = row.querySelector('.ws-body-text').value;
                    }
                    const remark = row.querySelector('.body-remark').value;
                    wsBodyItems.push({ type, value, selected: isSelected, remark });
                });
                body = { type: 'websocket', data: wsBodyItems };
            } else if (bodyType !== 'none') {
                // 對於其他類型的請求體，嘗試從多行結構中獲取
                body = { type: bodyType, data: document.getElementById('requestBody').value };
            }

            const historyItem = {
                method,
                url,
                headers,
                body,
                timestamp: new Date().toISOString()
            };

            // 獲取現有歷史記錄
            let history = StorageManager.get('requestHistory', []);

            // 添加新記錄到開頭
            history.unshift(historyItem);

            // 限制歷史記錄數量
            if (history.length > MAX_HISTORY_ITEMS) {
                history = history.slice(0, MAX_HISTORY_ITEMS);
            }

            // 保存回localStorage
            StorageManager.set('requestHistory', history);

            // 更新顯示
            updateHistoryDisplay();
        }

        /**
         * 從歷史記錄加載請求
         * 將歷史記錄中的請求信息恢覆到當前界面
         * @param {Object} historyItem - 歷史記錄項
         */
        function loadRequestFromHistory(historyItem) {
            // 添加數據有效性檢查
            if (!historyItem || typeof historyItem !== 'object') {
                console.error('無效的歷史記錄數據');
                return;
            }

            try {
                // 設置請求方法和URL
                document.getElementById('httpMethod').value = historyItem.method || 'GET';
                document.getElementById('url').value = historyItem.url || '';

                // 設置請求頭
                const headersList = document.getElementById('headersList');
                headersList.innerHTML = '';
                if (historyItem.headers && typeof historyItem.headers === 'object') {
                    Object.entries(historyItem.headers).forEach(([key, headerData]) => {
                        // 添加鍵值有效性檢查
                        if (key) {
                            const headerRow = document.createElement('div');
                            headerRow.className = 'header-row';
                            const isEnabled = typeof headerData === 'object' ? headerData.enabled : true;
                            const value = typeof headerData === 'object' ? headerData.value : headerData;
                            headerRow.innerHTML = `
                                <input type="checkbox" ${isEnabled ? 'checked' : ''}>
                                <input type="text" placeholder="Header名稱" value="${key}"/>
                                <input type="text" placeholder="Header值" value="${value}"/>
                                <input type="text" placeholder="備注" class="header-remark input-remark" value="${headerData.remark}"/>
                                <button class="remove-btn" onclick="removeHeader(this)">刪除</button>
                            `;
                            headersList.appendChild(headerRow);
                        }
                    });
                }
                if (!headersList.children.length) {
                    // 添加一個空的請求頭行
                    addHeader();
                }

                // 設置請求體
                if (historyItem.body && typeof historyItem.body === 'object') {
                    const bodyType = historyItem.body.type;
                    const bodyTypeRadio = document.querySelector(`input[name="bodyType"][value="${bodyType}"]`);
                    if (bodyTypeRadio) {
                        bodyTypeRadio.checked = true;
                        updateBodyType(bodyType);

                        if (bodyType === 'form' && historyItem.body.data && typeof historyItem.body.data === 'object') {
                            const formRows = document.getElementById('formRows');
                            formRows.innerHTML = '';
                            Object.entries(historyItem.body.data).forEach(([key, formData]) => {
                                // 添加鍵值有效性檢查
                                if (key) {
                                    const formRow = document.createElement('div');
                                    formRow.className = 'header-row';
                                    const isEnabled = typeof formData === 'object' ? formData.enabled : true;
                                    const value = typeof formData === 'object' ? formData.value : formData;
                                    formRow.innerHTML = `
                                        <input type="checkbox" ${isEnabled ? 'checked' : ''}>
                                        <input type="text" placeholder="參數名稱" value="${key}"/>
                                        <input type="text" placeholder="參數值" value="${value}"/>
                                        <input type="text" placeholder="備注" class="header-remark input-remark" value="${formData.remark}"/>
                                        <button class="remove-btn" onclick="removeFormRow(this)">刪除</button>
                                    `;
                                    formRows.appendChild(formRow);
                                }
                            });
                        } else if (bodyType === 'formdata' && Array.isArray(historyItem.body.data)) {
                            const formDataRows = document.getElementById('formDataRows');
                            formDataRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                // 添加數據有效性檢查
                                if (item && typeof item === 'object' && item.key) {
                                    const row = createFormDataRow();
                                    row.querySelector('input[type="checkbox"]').checked = item.enabled !== false;
                                    row.querySelector('.formdata-key').value = item.key;
                                    const typeSelect = row.querySelector('.formdata-type');
                                    typeSelect.value = item.type || 'text';
                                    if (item.type === 'text' && item.value !== undefined) {
                                        row.querySelector('.text-input').value = item.value;
                                    }
                                    // 備注賦值
                                    const remarkInput = row.querySelector('.formdata-remark');
                                    if (remarkInput) remarkInput.value = item.remark || '';
                                    handleTypeChange(typeSelect);
                                    formDataRows.appendChild(row);
                                }
                            });
                        } else if (bodyType === 'json' && Array.isArray(historyItem.body.data)) {
                            const jsonBodyRows = document.getElementById('jsonBodyRows');
                            jsonBodyRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                if (item && typeof item === 'object') {
                                    const row = createJsonBodyRow();
                                    row.querySelector('input[type="radio"]').checked = item.selected || false;
                                    row.querySelector('textarea').value = item.content || '';
                                    row.querySelector('.body-remark').value = item.remark || '';
                                    jsonBodyRows.appendChild(row);
                                }
                            });
                        } else if (bodyType === 'text' && Array.isArray(historyItem.body.data)) {
                            const textBodyRows = document.getElementById('textBodyRows');
                            textBodyRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                if (item && typeof item === 'object') {
                                    const row = createTextBodyRow();
                                    row.querySelector('input[type="radio"]').checked = item.selected || false;
                                    row.querySelector('textarea').value = item.content || '';
                                    row.querySelector('.body-remark').value = item.remark || '';
                                    textBodyRows.appendChild(row);
                                }
                            });
                        } else if (bodyType === 'binary' && Array.isArray(historyItem.body.data)) {
                            const binaryBodyRows = document.getElementById('binaryBodyRows');
                            binaryBodyRows.innerHTML = '';
                            historyItem.body.data.forEach(item => {
                                if (item && typeof item === 'object') {
                                    const row = createBinaryBodyRow();
                                    row.querySelector('input[type="radio"]').checked = item.selected || false;
                                    row.querySelector('.body-remark').value = item.remark || '';
                                    // 注意：文件內容無法恢覆，只能顯示文件名
                                    binaryBodyRows.appendChild(row);
                                }
                            });
                        } else if (['json', 'text'].includes(bodyType) && historyItem.body.data !== undefined) {
                            document.getElementById('requestBody').value = historyItem.body.data;
                        }
                    }
                } else {
                    // 如果沒有請求體，設置為默認值
                    const noneRadio = document.querySelector('input[name="bodyType"][value="none"]');
                    if (noneRadio) {
                        noneRadio.checked = true;
                        updateBodyType('none');
                    }
                }
            } catch (error) {
                console.error('加載請求數據時出錯:', error);
                alert('加載請求數據時出錯，請檢查數據格式是否正確');
            }
        }

        /**
         * 更新歷史記錄顯示
         * 從localStorage讀取歷史記錄並在頁面上顯示
         */
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const history = StorageManager.get('requestHistory', []);

            historyList.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleString('zh-CN');
                // 將歷史記錄項存儲在一個自定義屬性中
                const safeItem = JSON.stringify(item).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                return `
                    <div class="history-item">
                        <div class="history-time">${formattedDate}</div>
                        <div>
                            <span class="history-method">${item.method}</span>
                            <span class="history-url">${item.url}</span>
                        </div>
                        <button class="history-load-btn" data-history='${safeItem}'>加載請求</button>
                    </div>
                `;
            }).join('');

            // 為所有加載按鈕添加事件監聽器
            document.querySelectorAll('.history-load-btn').forEach(button => {
                button.addEventListener('click', function () {
                    try {
                        if (!this.dataset.history && !this.dataset.api) {
                            console.error('沒有找到歷史記錄數據');
                            return;
                        }
                        const historyItem = JSON.parse(this.dataset.history || this.dataset.api);
                        if (!historyItem || typeof historyItem !== 'object') {
                            console.error('無效的歷史記錄數據');
                            return;
                        }
                        loadRequestFromHistory(historyItem);
                    } catch (error) {
                        console.error('解析歷史記錄數據時出錯:', error);
                        alert('加載歷史記錄失敗，數據格式可能已損壞');
                    }
                });
            });
        }

        /**
         * 清空所有歷史記錄
         * 刪除localStorage中的所有歷史記錄
         */
        function clearHistory() {
            if (confirm('確定要清空所有歷史記錄嗎？此操作不可撤銷。')) {
                StorageManager.remove('requestHistory');
                updateHistoryDisplay();
            }
        }

        /**
         * 導出歷史記錄
         * 將歷史記錄導出為JSON文件
         */
        function exportHistory() {
            const history = StorageManager.get('requestHistory', []);
            if (history.length === 0) {
                return alert('歷史記錄為空，無需導出');
            }

            const dataStr = JSON.stringify(history, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'history_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 導入歷史記錄
         * 從JSON文件導入歷史記錄
         */
        function importHistory() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const history = JSON.parse(content);

                        // 數據有效性檢查
                        if (!Array.isArray(history)) {
                            throw new Error('導入的歷史記錄數據格式不正確');
                        }

                        // 限制導入的歷史記錄數量
                        const MAX_IMPORT_ITEMS = 50;
                        if (history.length > MAX_IMPORT_ITEMS) {
                            if (!confirm(`導入的歷史記錄項超過${MAX_IMPORT_ITEMS}條，是否繼續？`)) {
                                return;
                            }
                        }

                        // 獲取現有歷史記錄
                        let existingHistory = StorageManager.get('requestHistory', []);

                        // 合並歷史記錄
                        const mergedHistory = [...existingHistory, ...history];

                        // 去重，保留最新的記錄
                        const uniqueHistory = Array.from(new Map(mergedHistory.map(item => [item.url + JSON.stringify(item.headers), item])).values());

                        // 限制歷史記錄數量
                        const finalHistory = uniqueHistory.slice(-MAX_HISTORY_ITEMS);

                        // 保存到localStorage
                        StorageManager.set('requestHistory', finalHistory);

                        alert('歷史記錄導入成功');
                        updateHistoryDisplay();
                    } catch (error) {
                        alert('導入歷史記錄時發生錯誤: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 保存當前請求到接口列表
         * 將當前請求保存到選中的接口集合中
         */
        function saveToApis() {
            const name = prompt('請輸入接口名稱：');
            if (!name) return;

            const method = document.getElementById('httpMethod').value;
            const url = document.getElementById('url').value;
            const bodyType = getBodyType();

            // 獲取請求頭
            const headers = {};
            document.querySelectorAll('#headersList .header-row').forEach(row => {
                const inputs = row.getElementsByTagName('input');
                const isEnabled = inputs[0].checked;
                if (inputs[1].value) {
                    headers[inputs[1].value] = {
                        value: inputs[2].value || '',
                        enabled: isEnabled,
                        remark: inputs[3].value || ''
                    };
                }
            });

            // 獲取請求體
            let body = null;
            if (bodyType === 'form') {
                const formData = {};
                document.querySelectorAll('#formRows .header-row').forEach((row) => {
                    const inputs = row.getElementsByTagName('input');
                    const isEnabled = inputs[0].checked;
                    if (inputs[1].value) {
                        formData[inputs[1].value] = {
                            value: inputs[2].value || '',
                            enabled: isEnabled,
                            remark: inputs[3].value || ''
                        };
                    }
                });
                body = { type: 'form', data: formData };
            } else if (bodyType === 'formdata') {
                const formDataItems = [];
                document.querySelectorAll('.formdata-row').forEach(row => {
                    const key = row.querySelector('.formdata-key').value;
                    const type = row.querySelector('.formdata-type').value;
                    const isEnabled = row.querySelector('input[type="checkbox"]').checked;
                    if (key) {
                        const value = type === 'text' ? (row.querySelector('.text-input').value || '') : null;
                        const remarkInput = row.querySelector('.formdata-remark');
                        formDataItems.push({
                            key,
                            type,
                            value,
                            enabled: isEnabled,
                            remark: remarkInput ? remarkInput.value : ''
                        });
                    }
                });
                body = { type: 'formdata', data: formDataItems };
            } else if (bodyType === 'json') {
                const jsonBodyItems = [];
                document.querySelectorAll('#jsonBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    jsonBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'json', data: jsonBodyItems };
            } else if (bodyType === 'text') {
                const textBodyItems = [];
                document.querySelectorAll('#textBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const content = row.querySelector('textarea').value;
                    const remark = row.querySelector('.body-remark').value;
                    textBodyItems.push({
                        content,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'text', data: textBodyItems };
            } else if (bodyType === 'binary') {
                const binaryBodyItems = [];
                document.querySelectorAll('#binaryBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const fileInput = row.querySelector('input[type="file"]');
                    const remark = row.querySelector('.body-remark').value;
                    // 對於文件，我們只能保存文件名，不能保存文件內容
                    const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    binaryBodyItems.push({
                        fileName,
                        selected: isSelected,
                        remark
                    });
                });
                body = { type: 'binary', data: binaryBodyItems };
            } else if (bodyType === 'websocket') {
                const wsBodyItems = [];
                document.querySelectorAll('#wsBodyRows .body-row').forEach(row => {
                    const isSelected = row.querySelector('input[type="radio"]').checked;
                    const type = row.querySelector('.ws-body-type').value;
                    let value = '';
                    if (type === 'file') {
                        const fileInput = row.querySelector('.ws-body-file');
                        value = fileInput.files.length > 0 ? fileInput.files[0].name : '';
                    } else {
                        value = row.querySelector('.ws-body-text').value;
                    }
                    const remark = row.querySelector('.body-remark').value;
                    wsBodyItems.push({ type, value, selected: isSelected, remark });
                });
                body = { type: 'websocket', data: wsBodyItems };
            } else if (bodyType !== 'none') {
                body = { type: bodyType, data: document.getElementById('requestBody').value };
            }

            const apiItem = {
                name,
                method,
                url,
                headers,
                body,
                timestamp: new Date().toISOString()
            };

            // 選擇集合
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (!collection) {
                collection = { name: current, apis: [] };
                collections.push(collection);
            }
            collection.apis.unshift(apiItem);
            setApiCollections(collections);
            updateApisDisplay();
            switchPanelTab('apis');
        }

        /**
         * 更新接口列表顯示
         * 從localStorage讀取接口列表並在頁面上顯示
         */
        function updateApisDisplay() {
            const apisList = document.getElementById('apisList');
            const collections = getApiCollections();
            const current = getCurrentCollectionName();
            const collection = collections.find(c => c.name === current);
            const apis = collection ? collection.apis : [];
            apisList.innerHTML = apis.map((item, index) => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleString('zh-CN');
                const safeItem = JSON.stringify(item).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                return `
                    <div class="history-item">
                        <div class="history-time">${formattedDate}</div>
                        <div>
                            <strong>${item.name}</strong><br>
                            <span class="history-method">${item.method}</span>
                            <span class="history-url">${item.url}</span>
                        </div>
                        <button class="history-load-btn" data-api='${safeItem}'>加載請求</button>
                        <button class="remove-btn" onclick="removeApi(${index})">刪除</button>
                    </div>
                `;
            }).join('');
            document.querySelectorAll('#apisList .history-load-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const apiItem = JSON.parse(this.dataset.api);
                    loadRequestFromHistory(apiItem);
                });
            });
            updateApiCollectionSelect();
        }

        /**
         * 刪除接口
         * @param {number} index - 要刪除的接口索引
         */
        function removeApi(index) {
            if (!confirm('確定要刪除這個接口嗎？此操作不可撤銷。')) {
                return;
            }
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (collection && index >= 0 && index < collection.apis.length) {
                collection.apis.splice(index, 1);
                setApiCollections(collections);
                updateApisDisplay();
            }
        }

        /**
         * 清空當前集合下的所有接口
         */
        function clearApis() {
            if (!confirm('確定要清空當前集合下所有接口嗎？此操作不可撤銷。')) {
                return;
            }
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (collection) {
                collection.apis = [];
                setApiCollections(collections);
                updateApisDisplay();
            }
        }

        /**
         * 導出接口列表
         * 將當前集合的接口列表導出為JSON文件
         */
        function exportApis() {
            let collections = getApiCollections();
            let current = getCurrentCollectionName();
            let collection = collections.find(c => c.name === current);
            if (!collection || collection.apis.length === 0) {
                return alert('當前集合接口列表為空，無需導出');
            }
            const dataStr = JSON.stringify(collection.apis, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${current}_apis_export.json`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 導入接口列表
         * 從JSON文件導入接口列表
         */
        function importApis() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const apis = JSON.parse(content);
                        if (!Array.isArray(apis)) {
                            throw new Error('導入的接口數據格式不正確');
                        }
                        let collections = getApiCollections();
                        let current = getCurrentCollectionName();
                        let collection = collections.find(c => c.name === current);
                        if (!collection) {
                            collection = { name: current, apis: [] };
                            collections.push(collection);
                        }
                        // 合並接口列表
                        const mergedApis = [...collection.apis, ...apis];
                        // 去重，保留最新的記錄
                        const uniqueApis = Array.from(new Map(mergedApis.map(item => [item.name, item])).values());
                        collection.apis = uniqueApis;
                        setApiCollections(collections);
                        alert('接口列表導入成功');
                        updateApisDisplay();
                    } catch (error) {
                        alert('導入接口列表時發生錯誤: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 添加變量行
         * 在變量表格中添加一個新的變量行
         */
        function addVariableRow() {
            const tbody = document.getElementById('variablesTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" checked></td>
                <td><input type="text" class="var-name"></td>
                <td><input type="text" class="var-value"></td>
                <td><button class="remove-btn" onclick="removeVariableRow(this)">刪除</button></td>
            `;
            tbody.appendChild(row);
        }

        /**
         * 刪除變量行
         * @param {HTMLElement} button - 刪除按鈕元素
         */
        function removeVariableRow(button) {
            button.closest('tr').remove();
        }

        /**
         * 保存變量配置
         * 將變量表格中的內容保存到localStorage
         */
        function saveVariables() {
            const rows = document.querySelectorAll('#variablesTableBody tr');
            const envConf = [];
            const envData = new Map();

            rows.forEach((row, index) => {
                const enable = row.querySelector('input[type="checkbox"]').checked;
                const name = row.querySelector('.var-name').value.trim();
                const value = row.querySelector('.var-value').value.trim();

                // 檢查變量名和值是否包含非法字符
                if (name.includes('{') || name.includes('}') || value.includes('{') || value.includes('}')) {
                    alert('變量名和變量值不能包含 { 或 } 字符');
                    return;
                }

                // 添加到配置數組
                envConf.push({
                    row_id: index + 1,
                    enable: enable,
                    env_name: name,
                    env_value: value
                });

                // 如果啟用且有變量名，則添加到最終變量映射
                if (enable && name) {
                    envData.set(name, value);
                }
            });

            // 轉換為數組格式
            const envDataArray = Array.from(envData.entries()).map(([env_name, env_value]) => ({
                env_name,
                env_value
            }));

            // 保存到localStorage
            StorageManager.set('env_conf', envConf);
            StorageManager.set('env_data', envDataArray);

            alert('變量保存成功');
        }

        /**
         * 加載變量配置
         * 從localStorage讀取變量配置並顯示在表格中
         */
        function loadVariables() {
            const envConf = StorageManager.get('env_conf', []);
            const tbody = document.getElementById('variablesTableBody');
            tbody.innerHTML = '';

            envConf.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" ${item.enable ? 'checked' : ''}></td>
                    <td><input type="text" class="var-name" value="${item.env_name}"></td>
                    <td><input type="text" class="var-value" value="${item.env_value}"></td>
                    <td><button class="remove-btn" onclick="removeVariableRow(this)">刪除</button></td>
                `;
                tbody.appendChild(row);
            });

            if (envConf.length === 0) {
                addVariableRow();
            }
        }

        /**
         * 清空所有變量
         * 刪除localStorage中的所有變量配置
         */
        function clearVariables() {
            if (confirm('確定要清空所有變量嗎？此操作不可撤銷。')) {
                StorageManager.remove('env_conf');
                StorageManager.remove('env_data');
                loadVariables();
            }
        }

        /**
         * 導出變量配置
         * 將變量配置導出為JSON文件
         */
        function exportVariables() {
            const envConf = StorageManager.get('env_conf', []);
            if (envConf.length === 0) {
                return alert('沒有可導出的變量');
            }

            const dataStr = JSON.stringify(envConf, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'variables_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 導入變量配置
         * 從JSON文件導入變量配置
         */
        function importVariables() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const envConf = JSON.parse(content);

                        if (!Array.isArray(envConf)) {
                            throw new Error('導入的變量數據格式不正確');
                        }

                        StorageManager.set('env_conf', envConf);
                        loadVariables();
                        alert('變量導入成功');
                    } catch (error) {
                        alert('導入變量時發生錯誤: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 替換變量
         * 將文本中的{{變量名}}替換為對應的變量值
         * @param {string} text - 要替換的文本
         * @returns {string} 替換後的文本
         */
        function replaceVariables(text) {
            if (!text) return text;

            const envData = StorageManager.get('env_data', []);
            let result = text;

            envData.forEach(({ env_name, env_value }) => {
                const pattern = new RegExp(`{{${env_name}}}`, 'g');
                result = result.replace(pattern, env_value);
            });

            return result;
        }

        /**
         * 清空所有全局請求頭
         */
        function clearGlobalHeaders() {
            if (confirm('確定要清空所有全局頭嗎？此操作不可撤銷。')) {
                StorageManager.remove('globalHeaders');
                updateGlobalHeadersDisplay();
            }
        }

        /**
         * 添加全局請求頭行
         * 在全局請求頭表格中添加一個新的請求頭行
         */
        function addGlobalHeaderRow() {
            const tbody = document.getElementById('globalHeadersTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" checked></td>
                <td><input type="text" class="header-name"></td>
                <td><input type="text" class="header-value"></td>
                <td><button class="remove-btn" onclick="removeGlobalHeaderRow(this)">刪除</button></td>
            `;
            tbody.appendChild(row);
        }

        /**
         * 刪除全局請求頭行
         * @param {HTMLElement} button - 刪除按鈕元素
         */
        function removeGlobalHeaderRow(button) {
            button.closest('tr').remove();
        }

        /**
         * 保存全局請求頭配置
         * 將全局請求頭表格中的內容保存到localStorage
         */
        function saveGlobalHeaders() {
            const rows = document.querySelectorAll('#globalHeadersTableBody tr');
            const headerConf = [];
            const headerData = new Map();

            rows.forEach((row, index) => {
                const enable = row.querySelector('input[type="checkbox"]').checked;
                const name = row.querySelector('.header-name').value.trim();
                const value = row.querySelector('.header-value').value.trim();

                // 添加到配置數組
                headerConf.push({
                    row_id: index + 1,
                    enable: enable,
                    header_name: name,
                    header_value: value
                });

                // 如果啟用且有請求頭名稱，則添加到最終映射
                if (enable && name) {
                    headerData.set(name, value);
                }
            });

            // 轉換為數組格式
            const headerDataArray = Array.from(headerData.entries()).map(([header_name, header_value]) => ({
                header_name,
                header_value
            }));

            // 保存到localStorage
            StorageManager.set('header_conf', headerConf);
            StorageManager.set('header_data', headerDataArray);

            alert('全局請求頭保存成功');
        }

        /**
         * 加載全局請求頭配置
         * 從localStorage讀取全局請求頭配置並顯示在表格中
         */
        function loadGlobalHeaders() {
            const headerConf = StorageManager.get('header_conf', []);
            const tbody = document.getElementById('globalHeadersTableBody');
            tbody.innerHTML = '';

            headerConf.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" ${item.enable ? 'checked' : ''}></td>
                    <td><input type="text" class="header-name" value="${item.header_name}"></td>
                    <td><input type="text" class="header-value" value="${item.header_value}"></td>
                    <td><button class="remove-btn" onclick="removeGlobalHeaderRow(this)">刪除</button></td>
                `;
                tbody.appendChild(row);
            });

            if (headerConf.length === 0) {
                addGlobalHeaderRow();
            }
        }

        /**
         * 清空所有全局請求頭
         * 刪除localStorage中的所有全局請求頭配置
         */
        function clearGlobalHeaders() {
            if (confirm('確定要清空所有全局請求頭嗎？此操作不可撤銷。')) {
                StorageManager.remove('header_conf');
                StorageManager.remove('header_data');
                loadGlobalHeaders();
            }
        }

        /**
         * 導出全局請求頭配置
         * 將全局請求頭配置導出為JSON文件
         */
        function exportGlobalHeaders() {
            const headerConf = StorageManager.get('header_conf', []);
            if (headerConf.length === 0) {
                return alert('沒有可導出的全局請求頭');
            }

            const dataStr = JSON.stringify(headerConf, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'global_headers_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 導入全局請求頭配置
         * 從JSON文件導入全局請求頭配置
         */
        function importGlobalHeaders() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const headerConf = JSON.parse(content);

                        if (!Array.isArray(headerConf)) {
                            throw new Error('導入的全局請求頭數據格式不正確');
                        }

                        StorageManager.set('header_conf', headerConf);
                        loadGlobalHeaders();
                        alert('全局請求頭導入成功');
                    } catch (error) {
                        alert('導入全局請求頭時發生錯誤: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        /**
         * 獲取全局請求頭
         * 從localStorage讀取全局請求頭並返回對象
         * @returns {Object} 全局請求頭對象
         */
        function getGlobalHeaders() {
            const headerData = StorageManager.get('header_data', []);
            const headers = {};
            headerData.forEach(({ header_name, header_value }) => {
                const key = replaceVariables(header_name).trim();
                const value = replaceVariables(header_value).trim();
                headers[key] = value;
            });
            return headers;
        }

        /**
         * 打開設置對話框
         * 顯示請求配置設置對話框
         */
        function openSettings() {
            document.getElementById('dialogOverlay').style.display = 'block';
            document.getElementById('settingsDialog').style.display = 'block';
            loadSettings();
        }

        /**
         * 關閉設置對話框
         * 隱藏請求配置設置對話框
         */
        function closeSettings() {
            document.getElementById('dialogOverlay').style.display = 'none';
            document.getElementById('settingsDialog').style.display = 'none';
        }

        /**
         * 加載設置到對話框
         * 從localStorage讀取當前設置並顯示在對話框中
         */
        function loadSettings() {
            const currentSettings = getRequestSettings();
            document.getElementById('settingDefaultProtocol').value = currentSettings.default_protocol || 'http';
            document.getElementById('settingVerifySSL').value = currentSettings.verify_ssl;
            document.getElementById('settingFollowRedirect').value = currentSettings.follow_redirect;
            document.getElementById('settingTimeout').value = currentSettings.timeout;
            document.getElementById('settingRetryCount').value = currentSettings.retry_count;
            document.getElementById('settingRetryDelay').value = currentSettings.retry_delay;
            document.getElementById('settingSseEventTypes').value = currentSettings.sse_event_types || '';

            document.getElementById('settingCache').value = currentSettings.cache;
            document.getElementById('settingMode').value = currentSettings.mode;
            document.getElementById('settingCredentials').value = currentSettings.credentials;
            document.getElementById('settingRedirect').value = currentSettings.redirect;
            document.getElementById('settingReferrerPolicy').value = currentSettings.referrerPolicy;
            document.getElementById('settingReferrer').value = currentSettings.referrer === 'custom' ? 'custom' : currentSettings.referrer;
            document.getElementById('settingReferrerCustom').value = currentSettings.referrer !== 'about:client' && currentSettings.referrer !== '' ? currentSettings.referrer : '';
            document.getElementById('settingIntegrity').value = currentSettings.integrity;
            document.getElementById('settingKeepalive').value = currentSettings.keepalive.toString();
            handleReferrerChange();
        }

        /**
         * 保存設置
         * 將對話框中的設置保存到localStorage
         */
        function saveSettings() {
            const settings = {
                default_protocol: document.getElementById('settingDefaultProtocol').value,
                verify_ssl: document.getElementById('settingVerifySSL').value,
                follow_redirect: document.getElementById('settingFollowRedirect').value,
                timeout: document.getElementById('settingTimeout').value,
                retry_count: document.getElementById('settingRetryCount').value,
                retry_delay: document.getElementById('settingRetryDelay').value,
                sse_event_types: document.getElementById('settingSseEventTypes').value,

                cache: document.getElementById('settingCache').value,
                mode: document.getElementById('settingMode').value,
                credentials: document.getElementById('settingCredentials').value,
                redirect: document.getElementById('settingRedirect').value,
                referrerPolicy: document.getElementById('settingReferrerPolicy').value,
                referrer: document.getElementById('settingReferrer').value === 'custom'
                    ? document.getElementById('settingReferrerCustom').value
                    : document.getElementById('settingReferrer').value,
                integrity: document.getElementById('settingIntegrity').value,
                keepalive: document.getElementById('settingKeepalive').value === 'true'
            };
            StorageManager.set('requestSettings', settings);
            closeSettings();
        }

        /**
         * 獲取請求設置
         * 從localStorage讀取請求設置，如果沒有則使用默認值
         * @returns {Object} 請求設置對象
         */
        function getRequestSettings() {
            const settings = StorageManager.get('requestSettings', {});
            const defaultSettings = {
                cache: 'default',
                mode: 'cors',
                credentials: 'same-origin',
                redirect: 'follow',
                referrerPolicy: 'no-referrer-when-downgrade',
                referrer: 'about:client',
                integrity: '',
                keepalive: false,
                default_protocol: 'http',
                verify_ssl: 'N',
                follow_redirect: 'N',
                timeout: '0',
                retry_count: '0',
                retry_delay: '0',
                sse_event_types: ''
            };
            return { ...defaultSettings, ...settings };
        }

        /**
         * 處理Referrer設置變化
         * 當Referrer選擇為自定義時顯示自定義輸入框
         */
        function handleReferrerChange() {
            const referrerSelect = document.getElementById('settingReferrer');
            const customInput = document.getElementById('settingReferrerCustom');
            customInput.style.display = referrerSelect.value === 'custom' ? 'block' : 'none';
        }

        /**
         * 切換側邊欄面板標簽頁
         * @param {string} tab - 標簽頁名稱
         */
        function switchPanelTab(tab) {
            document.querySelectorAll('.panel-tab').forEach(tabElement => tabElement.classList.remove('active'));
            document.querySelectorAll('.panel-content').forEach(contentElement => contentElement.classList.remove('active'));

            const activeTab = document.querySelector(`.panel-tab[onclick="switchPanelTab('${tab}')"]`);
            const activeContent = document.getElementById(`${tab}Panel`);

            activeTab.classList.add('active');
            activeContent.classList.add('active');

            // 保存最後選中的標簽頁
            StorageManager.set('lastActiveTab', tab);
        }

        /**
         * 導出所有配置
         * 將歷史記錄、接口集合、變量、全局請求頭、請求設置導出為JSON文件
         */
        function exportAllConfig() {
            const config = {
                history: StorageManager.get('requestHistory', []),
                apiCollections: StorageManager.get('apiCollections', []),
                variables: StorageManager.get('env_conf', []),
                globalHeaders: StorageManager.get('header_conf', []),
                requestSettings: StorageManager.get('requestSettings', {})
            };

            const dataStr = JSON.stringify(config, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'curl_config_export.json';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * 導入所有配置
         * 從JSON文件導入所有配置
         */
        function importAllConfig() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const config = JSON.parse(content);

                        // 驗證配置格式
                        if (typeof config !== 'object') {
                            throw new Error('導入的配置文件格式不正確');
                        }

                        // 導入歷史記錄
                        if (Array.isArray(config.history)) {
                            StorageManager.set('requestHistory', config.history);
                        }

                        // 導入接口集合
                        if (Array.isArray(config.apiCollections)) {
                            StorageManager.set('apiCollections', config.apiCollections);
                            // 默認選中第一個集合
                            if (config.apiCollections.length > 0) {
                                setCurrentCollectionName(config.apiCollections[0].name);
                            }
                        }

                        // 導入變量配置
                        if (Array.isArray(config.variables)) {
                            StorageManager.set('env_conf', config.variables);
                            // 更新變量數據
                            const envData = config.variables
                                .filter(item => item.enable)
                                .map(({ env_name, env_value }) => ({ env_name, env_value }));
                            StorageManager.set('env_data', envData);
                        }

                        // 導入全局請求頭
                        if (Array.isArray(config.globalHeaders)) {
                            StorageManager.set('header_conf', config.globalHeaders);
                            // 更新請求頭數據
                            const headerData = config.globalHeaders
                                .filter(item => item.enable)
                                .map(({ header_name, header_value }) => ({ header_name, header_value }));
                            StorageManager.set('header_data', headerData);
                        }

                        // 導入請求配置
                        if (typeof config.requestSettings === 'object') {
                            StorageManager.set('requestSettings', config.requestSettings);
                        }

                        // 更新所有顯示
                        updateHistoryDisplay();
                        updateApisDisplay();
                        loadVariables();
                        loadGlobalHeaders();
                        loadSettings();
                        updateApiCollectionSelect();

                        alert('配置導入成功');
                    } catch (error) {
                        alert('導入配置時發生錯誤: ' + error.message);
                    }
                };

                reader.readAsText(file);
            });

            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // 集合相關邏輯
        function getApiCollections() {
            let collections = StorageManager.get('apiCollections', []);
            // 兼容老數據遷移
            if (collections.length === 0) {
                let oldApis = StorageManager.get('savedApis', []);
                collections = [{ name: '默認集合', apis: oldApis }];
                StorageManager.set('apiCollections', collections);
                StorageManager.remove('savedApis');
            }
            // 如果依然沒有集合，自動創建一個默認集合
            if (collections.length === 0) {
                collections = [{ name: '默認集合', apis: [] }];
                StorageManager.set('apiCollections', collections);
            }
            return collections;
        }

        function setApiCollections(collections) {
            StorageManager.set('apiCollections', collections);
        }

        function getCurrentCollectionName() {
            return StorageManager.get('currentApiCollection', '默認集合');
        }

        function setCurrentCollectionName(name) {
            StorageManager.set('currentApiCollection', name);
        }

        /**
         * 更新接口集合選擇下拉框
         * 根據當前集合列表更新下拉框選項
         */
        function updateApiCollectionSelect() {
            const collections = getApiCollections();
            const select = document.getElementById('apiCollectionSelect');
            select.innerHTML = collections.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            // 選中當前集合
            let current = getCurrentCollectionName();
            if (!collections.some(c => c.name === current)) {
                // 如果當前集合不存在，默認選第一個
                current = collections.length > 0 ? collections[0].name : '';
                setCurrentCollectionName(current);
            }
            select.value = current;
        }

        /**
         * 切換接口集合
         * 當用戶選擇不同的接口集合時更新顯示
         */
        function switchApiCollection() {
            const select = document.getElementById('apiCollectionSelect');
            setCurrentCollectionName(select.value);
            updateApisDisplay();
        }

        /**
         * 添加新的接口集合
         * 創建新的接口集合並設置為當前選中
         */
        function addApiCollection() {
            const name = prompt('請輸入新集合名稱：');
            if (!name) return;
            let collections = getApiCollections();
            if (collections.some(c => c.name === name)) {
                alert('集合名已存在');
                return;
            }
            collections.push({ name, apis: [] });
            setApiCollections(collections);
            setCurrentCollectionName(name);
            updateApiCollectionSelect();
            updateApisDisplay();
        }

        /**
         * 刪除當前接口集合
         * 刪除當前選中的接口集合，默認集合不能刪除
         */
        function removeApiCollection() {
            const current = getCurrentCollectionName();
            if (current === '默認集合') {
                alert('默認集合不能刪除');
                return;
            }
            if (!confirm('確定要刪除集合及其所有接口嗎？')) return;
            let collections = getApiCollections();
            collections = collections.filter(c => c.name !== current);
            setApiCollections(collections);
            setCurrentCollectionName('默認集合');
            updateApiCollectionSelect();
            updateApisDisplay();
        }

        /**
         * 新建請求
         * 清空當前請求的所有內容，包括URL、請求頭、請求體、響應等
         */
        function newRequest() {
            // 清空URL
            const urlInput = document.getElementById('url');
            if (urlInput) urlInput.value = '';

            // 清空請求頭
            const headersList = document.getElementById('headersList');
            if (headersList) {
                headersList.innerHTML = '';
                addHeader();
            }

            // 清空多行請求體
            const jsonBodyRows = document.getElementById('jsonBodyRows');
            if (jsonBodyRows) {
                jsonBodyRows.innerHTML = '';
            }
            const textBodyRows = document.getElementById('textBodyRows');
            if (textBodyRows) {
                textBodyRows.innerHTML = '';
            }
            const binaryBodyRows = document.getElementById('binaryBodyRows');
            if (binaryBodyRows) {
                binaryBodyRows.innerHTML = '';
            }

            // 清空form表單
            const formRows = document.getElementById('formRows');
            if (formRows) {
                formRows.innerHTML = '';
                addFormRow();
            }

            // 清空formdata
            const formDataRows = document.getElementById('formDataRows');
            if (formDataRows) {
                formDataRows.innerHTML = '';
                addFormDataRow();
            }

            // 清空WebSocket消息體
            const wsBodyRows = document.getElementById('wsBodyRows');
            if (wsBodyRows) {
                wsBodyRows.innerHTML = '';
            }

            // 重置body類型為none
            const noneRadio = document.querySelector('input[name="bodyType"][value="none"]');
            if (noneRadio) {
                noneRadio.checked = true;
                updateBodyType('none');
            }

            // 清空響應信息
            clearResponse();
        }

        // JSON格式化高亮相關變量
        let formattedJson = '';
        let isJsonFormatted = false;

        /**
         * 格式化響應體中的JSON內容並高亮顯示
         * 解析並格式化JSON字符串，渲染為高亮DOM結構
         * @returns {void}
         */
        function formatJsonResponse() {
            const responseBody = document.getElementById('responseBody');
            const jsonFormattedContainer = document.getElementById('jsonFormattedContainer');
            const formatJsonBtn = document.getElementById('formatJsonBtn');
            const copyFormattedBtn = document.getElementById('copyFormattedBtn');

            if (!responseBody || !jsonFormattedContainer || !formatJsonBtn || !copyFormattedBtn) {
                console.error('JSON格式化所需元素不存在');
                return;
            }

            try {
                const rawJson = responseBody.value.trim();
                if (!rawJson) {
                    alert('沒有JSON內容可格式化');
                    return;
                }

                const jsonObj = JSON.parse(rawJson);
                formattedJson = JSON.stringify(jsonObj, null, 4);

                // 渲染格式化後的JSON
                renderJsonWithDom(jsonObj);

                // 顯示格式化容器，隱藏原始textarea
                jsonFormattedContainer.style.display = 'block';
                responseBody.style.display = 'none';
                copyFormattedBtn.style.display = 'inline-block';
                isJsonFormatted = true;

            } catch (error) {
                alert('JSON格式錯誤: ' + (error.message || error));
                console.error('JSON格式化失敗:', error);
            }
        }

        /**
         * 覆制格式化後的JSON字符串到剪貼板
         * @returns {void}
         */
        /**
         * 覆制格式化JSON到剪貼板
         */
        async function copyFormattedJson() {
            if (!formattedJson) {
                alert("請先格式化JSON數據");
                return;
            }

            const copyFormattedBtn = document.getElementById('copyFormattedBtn');

            try {
                await navigator.clipboard.writeText(formattedJson);

                if (copyFormattedBtn) {
                    copyFormattedBtn.textContent = "✓ 已覆制!";
                    setTimeout(() => {
                        if (copyFormattedBtn) {
                            copyFormattedBtn.textContent = "覆制格式化JSON";
                        }
                    }, 2000);
                }
                console.log('格式化JSON已覆制到剪貼板');
            } catch (err) {
                console.error('覆制格式化JSON失敗:', err);
                alert("覆制失敗，請手動覆制內容");
            }
        }

        /**
         * JSON格式化:使用DOM渲染JSON
         * 將JSON數據渲染為可折疊的DOM結構，支持展開/收起功能
         * @param {any} data - 要渲染的JSON數據
         */
        function renderJsonWithDom(data) {
            const jsonFormattedContainer = document.getElementById('jsonFormattedContainer');
            jsonFormattedContainer.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'json-formatted';
            processValue(container, data);
            jsonFormattedContainer.appendChild(container);
        }

        /**
         * JSON格式化:處理不同類型的值
         * 根據數據類型創建對應的DOM元素，支持null、數組、對象、字符串、數字、布爾值
         * @param {HTMLElement} parent - 父元素
         * @param {any} data - 要處理的數據
         */
        function processValue(parent, data) {
            if (data === null) {
                createAndAppendSpan(parent, 'null', 'json-null');
            } else if (Array.isArray(data)) {
                processArray(parent, data);
            } else if (typeof data === 'object') {
                processObject(parent, data);
            } else if (typeof data === 'string') {
                createAndAppendSpan(parent, `"${data}"`, 'json-string');
            } else if (typeof data === 'number') {
                createAndAppendSpan(parent, data, 'json-number');
            } else if (typeof data === 'boolean') {
                createAndAppendSpan(parent, data ? 'true' : 'false', 'json-boolean');
            }
        }

        /**
         * JSON格式化:處理數組
         * 創建可折疊的數組DOM結構，支持展開/收起功能
         * @param {HTMLElement} parent - 父元素
         * @param {Array} arr - 要處理的數組
         */
        function processArray(parent, arr) {
            if (arr.length === 0) {
                createAndAppendSpan(parent, '[]', 'json-bracket');
                return;
            }
            // 折疊按鈕
            const arrow = document.createElement('span');
            arrow.textContent = '▼';
            arrow.className = 'json-arrow';
            // 括號
            const bracketSpan = document.createElement('span');
            bracketSpan.textContent = '[';
            bracketSpan.className = 'json-bracket';
            // 容器
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'json-container';
            arr.forEach((item, i) => {
                const itemDiv = document.createElement('div');
                processValue(itemDiv, item);
                if (i < arr.length - 1) {
                    createAndAppendSpan(itemDiv, ',', 'json-bracket');
                }
                itemsContainer.appendChild(itemDiv);
            });
            // 結束括號
            const endBracketDiv = document.createElement('div');
            const endBracketSpan = document.createElement('span');
            endBracketSpan.textContent = ']';
            endBracketSpan.className = 'json-bracket';
            endBracketDiv.appendChild(endBracketSpan);
            // 折疊邏輯
            arrow.onclick = function () {
                if (itemsContainer.style.display === 'none') {
                    itemsContainer.style.display = '';
                    endBracketDiv.style.display = '';
                    arrow.textContent = '▼';
                } else {
                    itemsContainer.style.display = 'none';
                    endBracketDiv.style.display = 'none';
                    arrow.textContent = '▶';
                }
            };
            // 組裝
            const headerDiv = document.createElement('div');
            headerDiv.appendChild(arrow);
            headerDiv.appendChild(bracketSpan);
            parent.appendChild(headerDiv);
            parent.appendChild(itemsContainer);
            parent.appendChild(endBracketDiv);
        }

        /**
         * JSON格式化:處理對象
         * 創建可折疊的對象DOM結構，支持展開/收起功能
         * @param {HTMLElement} parent - 父元素
         * @param {Object} obj - 要處理的對象
         */
        function processObject(parent, obj) {
            const keys = Object.keys(obj);
            if (keys.length === 0) {
                createAndAppendSpan(parent, '{}', 'json-bracket');
                return;
            }
            // 折疊按鈕
            const arrow = document.createElement('span');
            arrow.textContent = '▼';
            arrow.className = 'json-arrow';
            // 括號
            const bracketSpan = document.createElement('span');
            bracketSpan.textContent = '{';
            bracketSpan.className = 'json-bracket';
            // 屬性容器
            const propsContainer = document.createElement('div');
            propsContainer.className = 'json-container';
            keys.forEach((key, i) => {
                const propDiv = document.createElement('div');
                createAndAppendSpan(propDiv, `"${key}":`, 'json-key');
                createAndAppendSpan(propDiv, ' ', null);
                processValue(propDiv, obj[key]);
                if (i < keys.length - 1) {
                    createAndAppendSpan(propDiv, ',', 'json-bracket');
                }
                propsContainer.appendChild(propDiv);
            });
            // 結束括號
            const endBracketDiv = document.createElement('div');
            const endBracketSpan = document.createElement('span');
            endBracketSpan.textContent = '}';
            endBracketSpan.className = 'json-bracket';
            endBracketDiv.appendChild(endBracketSpan);
            // 折疊邏輯
            arrow.onclick = function () {
                if (propsContainer.style.display === 'none') {
                    propsContainer.style.display = '';
                    endBracketDiv.style.display = '';
                    arrow.textContent = '▼';
                } else {
                    propsContainer.style.display = 'none';
                    endBracketDiv.style.display = 'none';
                    arrow.textContent = '▶';
                }
            };
            // 組裝
            const headerDiv = document.createElement('div');
            headerDiv.appendChild(arrow);
            headerDiv.appendChild(bracketSpan);
            parent.appendChild(headerDiv);
            parent.appendChild(propsContainer);
            parent.appendChild(endBracketDiv);
        }

        /**
         * JSON格式化:創建並添加帶樣式的span
         * 創建帶樣式的span元素並添加到父元素中
         * @param {HTMLElement} parent - 父元素
         * @param {string} content - 內容
         * @param {string} className - CSS類名
         * @param {boolean} newLine - 是否換行
         */
        function createAndAppendSpan(parent, content, className, newLine = false) {
            const span = document.createElement('span');
            span.textContent = content;
            if (className) span.className = className;

            if (newLine) {
                const div = document.createElement('div');
                div.appendChild(span);
                parent.appendChild(div);
            } else {
                parent.appendChild(span);
            }
        }

        /**
         * SSE流式Fetch響應處理函數
         * 處理fetch返回的SSE流式響應，實時顯示數據
         * @param {Response} response - fetch響應對象
         * @returns {Promise<void>}
         */
        async function handleSSEFetchResponse(response) {
            const responseInfo = document.getElementById('responseInfo');
            const responseBody = document.getElementById('responseBody');
            const responseHeadersTable = document.getElementById('responseHeaders')?.getElementsByTagName('tbody')[0];

            if (responseInfo) responseInfo.innerHTML = 'SSE流式響應中...';

            // 顯示響應頭
            if (responseHeadersTable) {
                responseHeadersTable.innerHTML = '';
                response.headers.forEach((value, key) => {
                    const row = responseHeadersTable.insertRow();
                    row.insertCell(0).textContent = key;
                    row.insertCell(1).textContent = value;
                });
            }

            if (responseBody) responseBody.value = '';

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let dataBuffer = '';
            let result = '';

            async function readStream() {
                try {
                    const { value, done } = await reader.read();

                    if (done) {
                        if (responseInfo) responseInfo.innerHTML = 'SSE流式響應已結束';
                        return;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    //console.log('收到數據塊:', chunk);
                    dataBuffer += chunk;

                    // 處理SSE事件
                    const lines = dataBuffer.split('\n');
                    dataBuffer = lines.pop() || '';

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        // console.log('處理行:', trimmedLine);

                        // 顯示所有非空行，不僅僅是data:開頭的
                        if (trimmedLine) {
                            if (trimmedLine.startsWith('data:')) {
                                const data = trimmedLine.slice(5).trim();
                                if (data) {
                                    result += data + '\n';
                                    if (responseBody) responseBody.value = result;
                                }
                            } else {
                                // 顯示非標準SSE格式的行
                                result += trimmedLine + '\n';
                                if (responseBody) responseBody.value = result;
                            }
                        }
                    }

                    readStream();
                } catch (err) {
                    console.error('SSE讀取錯誤:', err);
                    if (responseInfo) responseInfo.innerHTML = 'SSE讀取失敗：' + err;
                }
            }

            readStream();
        }

        /**
         * 創建WebSocket消息體行
         * 創建一個包含radio選擇、類型選擇、消息體輸入、備注和刪除按鈕的WebSocket消息體行
         * @returns {HTMLElement} 創建的WebSocket消息體行元素
         */
        function createWsBodyRow() {
            const row = document.createElement('div');
            row.className = 'body-row';
            row.innerHTML = `
                <input type="radio" name="wsBodyRadio">
                <select class="ws-body-type">
                    <option value="text">文本</option>
                    <option value="binary">二進制(Base64)</option>
                    <option value="file">文件</option>
                </select>
                <div class="ws-body-content">
                    <textarea class="ws-body-text" placeholder="消息內容"></textarea>
                    <input type="file" class="ws-body-file file-input-ws">
                </div>
                <textarea class="body-remark" placeholder="備注"></textarea>
                <button class="remove-btn" type="button" onclick="removeWsBodyRow(this)">刪除</button>
            `;
            // 類型切換
            const typeSelect = row.querySelector('.ws-body-type');
            const textArea = row.querySelector('.ws-body-text');
            const fileInput = row.querySelector('.ws-body-file');
            typeSelect.onchange = function () {
                if (this.value === 'file') {
                    textArea.style.display = 'none';
                    fileInput.style.display = 'block';
                } else {
                    textArea.style.display = 'block';
                    fileInput.style.display = 'none';
                }
            };
            return row;
        }

        /**
         * 添加WebSocket消息體行
         * 在WebSocket消息體容器中添加一個新的消息體行，如果是第一行則自動選中
         */
        function addWsBodyRow() {
            const container = document.getElementById('wsBodyRows');
            const row = createWsBodyRow();
            container.appendChild(row);
            // 如果是第一行，自動選中
            if (container.children.length === 1) {
                row.querySelector('input[type="radio"]').checked = true;
            }
        }

        /**
         * 刪除WebSocket消息體行
         * 刪除指定的消息體行，如果刪除的是選中的行且還有其他行，則選中第一行
         * @param {HTMLElement} btn - 刪除按鈕元素
         */
        function removeWsBodyRow(btn) {
            const row = btn.closest('.body-row');
            const container = document.getElementById('wsBodyRows');
            const wasSelected = row.querySelector('input[type="radio"]').checked;
            row.remove();
            if (wasSelected && container.children.length > 0) {
                container.children[0].querySelector('input[type="radio"]').checked = true;
            }
            if (container.children.length === 0) {
                addWsBodyRow();
            }
        }

        /**
         * 發送WebSocket消息體
         * 發送當前選中的WebSocket消息體行，根據類型處理（text直接發送，binary base64解碼，file讀取為二進制）
         * @returns {Promise<void>}
         */
        async function sendWsBody() {
            if (!currentWS || currentWS.readyState !== 1) {
                alert('WebSocket未連接');
                return;
            }
            const rows = document.querySelectorAll('#wsBodyRows .body-row');
            let found = false;
            for (const row of rows) {
                if (row.querySelector('input[type="radio"]').checked) {
                    found = true;
                    const type = row.querySelector('.ws-body-type').value;
                    if (type === 'text') {
                        const val = row.querySelector('.ws-body-text').value;
                        currentWS.send(val);
                    } else if (type === 'binary') {
                        const val = row.querySelector('.ws-body-text').value;
                        try {
                            const bin = Uint8Array.from(atob(val), c => c.charCodeAt(0));
                            currentWS.send(bin);
                        } catch (e) {
                            alert('Base64解碼失敗');
                        }
                    } else if (type === 'file') {
                        const fileInput = row.querySelector('.ws-body-file');
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            const buf = await file.arrayBuffer();
                            currentWS.send(buf);
                        } else {
                            alert('請選擇文件');
                        }
                    }
                    break;
                }
            }
            if (!found) alert('請選擇要發送的消息行');
        }

        /**
         * 頁面初始化
         * 在DOM加載完成後執行所有初始化操作
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 並行初始化所有組件
                await Promise.all([
                    addFormDataRow(),
                    addFormRow(),
                    loadGlobalHeaders(),
                    updateHistoryDisplay(),
                    updateApisDisplay(),
                    loadVariables(),
                    initUseProxy(),
                    updateApiCollectionSelect()
                ]);

                // 恢覆上次選中的標簽頁
                const lastActiveTab = StorageManager.get('lastActiveTab', 'history');
                switchPanelTab(lastActiveTab);
            } catch (error) {
                console.error('頁面初始化失敗:', error);
            }
        });

    </script>
</body>

</html>
